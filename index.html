<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cosmic Letter</title>

<style>
html,body{
  margin:0;
  background:black;
  overflow:hidden;
}
canvas{position:fixed;top:0;left:0}
video{
  position:fixed;
  bottom:12px;
  right:12px;
  width:110px;
  border-radius:12px;
  opacity:.75;
  transform:scaleX(-1);
}
</style>
</head>
<body>

<canvas id="c"></canvas>
<video id="cam" autoplay playsinline></video>

<script>
/* ================= SETUP ================= */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
function resize(){
  canvas.width=innerWidth;
  canvas.height=innerHeight;
}
resize(); addEventListener("resize",resize);

/* ================= CAMERA ================= */
const video=document.getElementById("cam");
navigator.mediaDevices.getUserMedia({video:true})
.then(s=>video.srcObject=s);

/* ================= STARS ================= */
const STAR_COUNT = 900;
const stars=[];
for(let i=0;i<STAR_COUNT;i++){
  stars.push({
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height,
    z:Math.random(),
    tx:null, ty:null,
    vx:(Math.random()-.5)*0.3,
    vy:(Math.random()-.5)*0.3
  });
}

/* ================= DRAW ================= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  stars.forEach(s=>{
    if(s.tx!==null){
      s.x += (s.tx-s.x)*0.06;
      s.y += (s.ty-s.y)*0.06;
    }else{
      s.x+=s.vx;
      s.y+=s.vy;
    }
    if(s.x<0||s.x>canvas.width) s.vx*=-1;
    if(s.y<0||s.y>canvas.height) s.vy*=-1;

    const size = 1.2 + s.z*1.6;
    ctx.fillStyle=`rgba(180,220,255,0.85)`;
    ctx.beginPath();
    ctx.arc(s.x,s.y,size,0,Math.PI*2);
    ctx.fill();
  });
  requestAnimationFrame(draw);
}
draw();

/* ================= TEXT MORPH ================= */
function textToStars(text){
  const off=document.createElement("canvas");
  const octx=off.getContext("2d");
  off.width=canvas.width;
  off.height=canvas.height;

  octx.clearRect(0,0,off.width,off.height);
  octx.fillStyle="white";
  octx.font=`bold ${Math.min(canvas.width/15,52)}px Georgia`;
  octx.textAlign="center";
  octx.textBaseline="middle";

  const lines=text.split("\n");
  lines.forEach((l,i)=>{
    octx.fillText(l,off.width/2,off.height/2+i*70);
  });

  const img=octx.getImageData(0,0,off.width,off.height).data;
  const pts=[];
  for(let y=0;y<off.height;y+=7){
    for(let x=0;x<off.width;x+=7){
      if(img[(y*off.width+x)*4]>200){
        pts.push({x,y});
      }
    }
  }

  stars.forEach((s,i)=>{
    const p=pts[i%pts.length];
    s.tx=p.x;
    s.ty=p.y;
  });
}

/* ================= RELEASE ================= */
function releaseStars(){
  stars.forEach(s=>{
    s.tx=null;
    s.ty=null;
  });
}

/* ================= MESSAGES ================= */
const MSG_OPEN =
`Dear Laily Aliyah,
I want to sincerely apologize for the situation that happened.
I was honest from the beginning,
and my words came from a sincere place.`;

const MSG_FIST =
`I’m really sorry for the misunderstanding.
ilysm ly ♥
from: Raja Iblis`;

/* ================= HAND DETECTION ================= */
const off=document.createElement("canvas");
const offCtx=off.getContext("2d");
off.width=160; off.height=120;

let last=null;
let stable=0;
let currentMode="idle";
let cooldown=false;

setInterval(()=>{
  if(video.videoWidth===0)return;
  offCtx.drawImage(video,0,0,off.width,off.height);
  const d=offCtx.getImageData(0,0,off.width,off.height).data;

  if(last){
    let diff=0;
    for(let i=0;i<d.length;i+=4){
      diff+=Math.abs(d[i]-last[i]);
    }

    if(diff>220000){
      stable++;
      if(stable>6 && !cooldown){
        let mode = diff > 360000 ? "open" : "fist";

        if(mode!==currentMode){
          currentMode=mode;
          cooldown=true;

          if(mode==="open") textToStars(MSG_OPEN);
          if(mode==="fist") textToStars(MSG_FIST);

          setTimeout(()=>cooldown=false,1500);
        }
      }
    }else{
      stable=0;
    }
  }
  last=d;
},200);
</script>
</body>
</html>
