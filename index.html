<!-- (TRUNCATED HEADER & STYLE TETAP SAMA DENGAN FASE 4A) -->
<script>
/* =========================
   TEXT TARGET FACTORY
========================= */
function generateTextTargets(text, scale=0.3) {
  const c=document.createElement("canvas");
  c.width=900; c.height=240;
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  ctx.font="64px serif";
  ctx.textAlign="center";
  ctx.fillStyle="white";
  ctx.fillText(text,c.width/2,c.height/2);

  const d=ctx.getImageData(0,0,c.width,c.height).data;
  const t=[];
  for(let y=0;y<c.height;y+=4){
    for(let x=0;x<c.width;x+=4){
      if(d[(y*c.width+x)*4+3]>150){
        t.push({x:(x-c.width/2)*scale,y:(c.height/2-y)*scale,z:0});
      }
    }
  }
  return t;
}

/* =========================
   HEART TARGET
========================= */
function generateHeartTargets() {
  const t=[];
  for(let i=0;i<COUNT;i++){
    const a=Math.random()*Math.PI*2;
    const r=16*(1-Math.sin(a));
    t.push({x:r*Math.cos(a),y:r*Math.sin(a),z:0});
  }
  return t;
}

/* =========================
   TARGET MAP
========================= */
const TARGETS={
  "1 finger":generateTextTargets("Dear Laily"),
  "2 fingers":generateTextTargets("I'm sorry…"),
  "3 fingers":generateTextTargets("I miss you"),
  "4 fingers":generateTextTargets("Please forgive me"),
  "5 fingers":generateTextTargets("I love you ❤️",0.28),
  "fist":generateHeartTargets()
};

let activeTargets=null;

/* =========================
   MODIFY ANIMATE LOOP
========================= */
function animate() {
  requestAnimationFrame(animate);

  activeTargets = TARGETS[stableGesture] || null;

  const p=geo.attributes.position.array;
  for(let i=0;i<COUNT;i++){
    const i3=i*3;
    let tx,ty,tz;
    if(activeTargets && i<activeTargets.length){
      ({x:tx,y:ty,z:tz}=activeTargets[i]);
    } else {
      tx=basePos[i3]; ty=basePos[i3+1]; tz=basePos[i3+2];
    }
    p[i3]+= (tx-p[i3])*0.08;
    p[i3+1]+= (ty-p[i3+1])*0.08;
    p[i3+2]+= (tz-p[i3+2])*0.08;
  }
  geo.attributes.position.needsUpdate=true;
  renderer.render(scene,camera3D);
}
</script>
