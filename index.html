<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cosmic Gesture Message</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital@0;1&family=Great+Vibes&display=swap" rel="stylesheet">

<style>
html,body{margin:0;padding:0;background:#000;overflow:hidden;font-family:'Playfair Display',serif;color:#fff}
#container{position:fixed;inset:0}
#gestureStatus{position:fixed;top:10px;left:50%;transform:translateX(-50%);font-size:13px;opacity:.8;z-index:5}

#cameraBox{
 position:fixed;bottom:12px;right:12px;width:120px;height:160px;
 border-radius:14px;overflow:hidden;
 border:2px solid rgba(255,255,255,.4);
 box-shadow:0 0 20px rgba(180,120,255,.8);
 z-index:5
}
#cameraBox video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
#cameraGuide{position:absolute;inset:14px;border:1px dashed rgba(255,255,255,.6);border-radius:10px}

#startOverlay{
 position:fixed;inset:0;z-index:10;
 display:flex;align-items:center;justify-content:center;
 background:radial-gradient(circle,#2a0055,#000);
 text-align:center
}
#startOverlay button{
 padding:16px 28px;border-radius:40px;border:none;
 background:linear-gradient(135deg,#ff9ad5,#9b7bff);
 font-size:18px;cursor:pointer;
 box-shadow:0 0 30px rgba(255,180,255,.6)
}
</style>
</head>

<body>
<div id="container"></div>
<div id="gestureStatus">Detecting…</div>

<div id="cameraBox">
 <video id="video" playsinline></video>
 <div id="cameraGuide"></div>
</div>

<div id="startOverlay">
 <div>
  <h2>✨ Tap to Start ✨</h2>
  <p>Arahkan tangan ke tengah kamera</p>
  <button id="startBtn">Start</button>
 </div>
</div>

<audio id="bgm" loop>
 <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_4c3c3a1f1a.mp3">
</audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<script>
/* ========= SCENE ========= */
let scene=new THREE.Scene();
scene.fog=new THREE.FogExp2(0x060010,0.0015);

let camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,1,3000);
camera.position.z=420;

let renderer=new THREE.WebGLRenderer({antialias:false});
renderer.setPixelRatio(Math.min(devicePixelRatio,1.5));
renderer.setSize(innerWidth,innerHeight);
document.getElementById('container').appendChild(renderer.domElement);

/* ========= NEBULA ========= */
let nebulaGeo=new THREE.BufferGeometry();
let nebulaCount=600;
let nebulaPos=new Float32Array(nebulaCount*3);
for(let i=0;i<nebulaCount;i++){
 nebulaPos[i*3]=(Math.random()-0.5)*2000;
 nebulaPos[i*3+1]=(Math.random()-0.5)*2000;
 nebulaPos[i*3+2]=(Math.random()-0.5)*2000;
}
nebulaGeo.setAttribute('position',new THREE.BufferAttribute(nebulaPos,3));
let nebula=new THREE.Points(
 nebulaGeo,
 new THREE.PointsMaterial({color:0x8833ff,size:8,opacity:.15,transparent:true})
);
scene.add(nebula);

/* ========= STARS ========= */
const STAR_COUNT=innerWidth<768?1200:2600;
let geo=new THREE.BufferGeometry();
let pos=new Float32Array(STAR_COUNT*3);
let target=new Float32Array(STAR_COUNT*3);

for(let i=0;i<STAR_COUNT;i++){
 pos[i*3]=(Math.random()-0.5)*1200;
 pos[i*3+1]=(Math.random()-0.5)*1200;
 pos[i*3+2]=(Math.random()-0.5)*1200;
 target.set(pos);
}
geo.setAttribute('position',new THREE.BufferAttribute(pos,3));

let stars=new THREE.Points(
 geo,
 new THREE.PointsMaterial({
  color:0xffffff,size:1.6,transparent:true,
  blending:THREE.AdditiveBlending
 })
);
scene.add(stars);

/* ========= ANIMATE ========= */
function animate(){
 requestAnimationFrame(animate);
 nebula.rotation.y+=0.0002;
 nebula.rotation.x+=0.0001;

 let p=geo.attributes.position.array;
 for(let i=0;i<STAR_COUNT*3;i++){
  p[i]+= (target[i]-p[i]) * 0.05;
 }
 geo.attributes.position.needsUpdate=true;
 renderer.render(scene,camera);
}
animate();

addEventListener('resize',()=>{
 camera.aspect=innerWidth/innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(innerWidth,innerHeight);
});

/* ========= TEXT / SHAPE ========= */
function buildFromCanvas(draw){
 let c=document.createElement('canvas');
 let ctx=c.getContext('2d');
 let portrait=innerHeight>innerWidth;
 c.width=portrait?360:800;
 c.height=portrait?520:360;

 ctx.fillStyle="#000";ctx.fillRect(0,0,c.width,c.height);
 draw(ctx,c);

 let img=ctx.getImageData(0,0,c.width,c.height).data;
 let i=0;
 for(let y=0;y<c.height;y+=4){
  for(let x=0;x<c.width;x+=4){
   if(img[(y*c.width+x)*4]>10 && i<STAR_COUNT){
    target[i*3]=x-c.width/2;
    target[i*3+1]=c.height/2-y;
    target[i*3+2]=0;
    i++;
   }
  }
 }
}

function textMorph(text){
 buildFromCanvas((ctx,c)=>{
  ctx.fillStyle="#fff";
  ctx.font=(innerHeight>innerWidth?24:30)+"px Playfair Display";
  ctx.textAlign="center";ctx.textBaseline="top";
  let lines=text.split("\n");
  lines.forEach((l,i)=>ctx.fillText(l,c.width/2,40+i*40));
 });
}

function heartMorph(){
 buildFromCanvas((ctx,c)=>{
  ctx.fillStyle="#fff";
  ctx.translate(c.width/2,c.height/2);
  ctx.scale(1.3,1.3);
  ctx.beginPath();
  ctx.moveTo(0,40);
  ctx.bezierCurveTo(-80,-40,-40,-120,0,-40);
  ctx.bezierCurveTo(40,-120,80,-40,0,40);
  ctx.fill();
 });
}

function resetGalaxy(){
 for(let i=0;i<STAR_COUNT;i++){
  target[i*3]=(Math.random()-0.5)*1200;
  target[i*3+1]=(Math.random()-0.5)*1200;
  target[i*3+2]=(Math.random()-0.5)*1200;
 }
}

/* ========= HAND TRACK ========= */
const video=document.getElementById("video");
const status=document.getElementById("gestureStatus");

const hands=new Hands({
 locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
 maxNumHands:1,
 modelComplexity:0,
 selfieMode:true,
 minDetectionConfidence:.75,
 minTrackingConfidence:.7
});

let last=null,lastT=0;

function fingerExtended(tip,pip,mcp){
 return Math.atan2(tip.y-pip.y,tip.x-pip.x) <
        Math.atan2(pip.y-mcp.y,pip.x-mcp.x);
}

hands.onResults(r=>{
 if(!r.multiHandLandmarks){resetGalaxy();status.textContent="Detecting…";last=null;return;}
 let lm=r.multiHandLandmarks[0];
 let f=0;
 if(fingerExtended(lm[8],lm[6],lm[5]))f++;
 if(fingerExtended(lm[12],lm[10],lm[9]))f++;
 if(fingerExtended(lm[16],lm[14],lm[13]))f++;
 if(fingerExtended(lm[20],lm[18],lm[17]))f++;

 let g=f===0?"fist":f;
 let now=Date.now();
 if(g!==last && now-lastT>900){
  last=g;lastT=now;
  if(g===1)textMorph(`Dear Laily Aliyah,\n\nI want to sincerely apologize for the situation that happened.\nI’m truly sorry if everything made you feel disappointed,\nconfused, or hurt.\n\nWhat hurts me the most is knowing that you thought\nI was lying, even though I was honest from the beginning.`);
  if(g===2)textMorph(`I never intended to deceive you or break your trust.\nI understand your feelings and respect them.\nI hope one day you can believe\nmy words came from a sincere place.`);
  if(g===3)textMorph(`I’m really sorry for the misunderstanding.\nI hope we can clear things up\nand move forward with honesty and respect.`);
  if(g===4)heartMorph();
  if(g===5)textMorph(`ilysm ly ♥`);
  if(g==="fist")textMorph(`from:\nRaja Iblis`);
 }
 status.textContent="Detected: "+g;
});

/* ========= START ========= */
document.getElementById("startBtn").onclick=async()=>{
 document.getElementById("startOverlay").style.display="none";
 let stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:640,height:480}});
 video.srcObject=stream;await video.play();
 new Camera(video,{onFrame:()=>hands.send({image:video}),width:640,height:480}).start();
 document.getElementById("bgm").play();
};
</script>
</body>
</html>
