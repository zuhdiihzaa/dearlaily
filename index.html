<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dear Laily â€” Cinematic Galaxy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Great+Vibes&display=swap" rel="stylesheet">

<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  overflow:hidden;
  background:#000;
  font-family:'Playfair Display',serif;
}
canvas{display:block}

#overlay{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:20;
  cursor:pointer;
  user-select:none;
}
#overlay h1{
  color:#fff;
  font-size:2rem;
  opacity:.85;
  animation:pulse 2s infinite;
}
@keyframes pulse{
  0%,100%{opacity:.4}
  50%{opacity:1}
}

#status{
  position:fixed;
  top:10px;
  left:10px;
  font-size:12px;
  color:#9cf;
  z-index:5;
}

#gestureInfo{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  font-size:14px;
  color:#fff;
  opacity:0;
  transition:opacity .5s;
  z-index:5;
}

#camBox{
  position:fixed;
  right:10px;
  bottom:10px;
  width:160px;
  aspect-ratio:4/3;
  border-radius:8px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.3);
  display:none;
  z-index:5;
}
#camBox video{
  width:100%;
  height:100%;
  object-fit:cover;
  transform:scaleX(-1);
}
#camOverlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.25);
  color:#fff;
  font-size:11px;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}
</style>
</head>

<body>
<div id="overlay"><h1>Tap anywhere to start</h1></div>
<div id="status">CAMERA: OFF</div>
<div id="gestureInfo"></div>

<div id="camBox">
  <video id="video" playsinline muted></video>
  <div id="camOverlay">Place your hand<br>in the center</div>
</div>

<audio id="music" loop>
  <source src="https://cdn.pixabay.com/download/audio/2022/08/02/audio_8b77f6b86b.mp3?filename=deep-space-ambient-110624.mp3">
</audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ================= THREE ================= */
const scene=new THREE.Scene()
scene.fog=new THREE.FogExp2(0x000010,0.0006)

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,1,2000)
camera.position.z=500

const renderer=new THREE.WebGLRenderer({antialias:true})
renderer.setSize(innerWidth,innerHeight)
renderer.setPixelRatio(devicePixelRatio)
document.body.appendChild(renderer.domElement)

addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight
  camera.updateProjectionMatrix()
  renderer.setSize(innerWidth,innerHeight)
})

/* ================= PARTICLES ================= */
const COUNT=9000
const positions=new Float32Array(COUNT*3)
const galaxy=new Float32Array(COUNT*3)
const target=new Float32Array(COUNT*3)

for(let i=0;i<COUNT;i++){
  const r=Math.random()*900
  const a=Math.random()*Math.PI*2
  const y=(Math.random()-.5)*300
  galaxy[i*3]=Math.cos(a)*r
  galaxy[i*3+1]=y
  galaxy[i*3+2]=Math.sin(a)*r
  positions.set(galaxy,i*3)
  target.set(galaxy,i*3)
}

const geo=new THREE.BufferGeometry()
geo.setAttribute('position',new THREE.BufferAttribute(positions,3))

const mat=new THREE.PointsMaterial({
  color:0xffffff,
  size:2,
  transparent:true,
  opacity:.85,
  blending:THREE.AdditiveBlending,
  depthWrite:false
})

const stars=new THREE.Points(geo,mat)
scene.add(stars)

/* ================= ANIMATE ================= */
let time=0
function animate(){
  requestAnimationFrame(animate)
  time+=0.002

  const p=geo.attributes.position.array
  for(let i=0;i<COUNT;i++){
    const ix=i*3
    p[ix]+= (target[ix]-p[ix])*0.04
    p[ix+1]+= (target[ix+1]-p[ix+1])*0.04
    p[ix+2]+= (target[ix+2]-p[ix+2])*0.04
    const tw=1+Math.sin(time+i)*0.002
    p[ix]*=tw; p[ix+1]*=tw; p[ix+2]*=tw
  }
  geo.attributes.position.needsUpdate=true

  stars.rotation.y+=0.0006
  stars.rotation.x+=0.0002

  renderer.render(scene,camera)
}
animate()

/* ================= SHAPES ================= */
function toGalaxy(){ target.set(galaxy) }

function toHeart(){
  for(let i=0;i<COUNT;i++){
    const t=Math.random()*Math.PI*2
    const r=12*Math.sqrt(Math.random())
    const x=r*Math.sin(t)
    const z=r*Math.cos(t)
    const y=Math.abs(x)*0.8
    target[i*3]=x*14
    target[i*3+1]=y*14
    target[i*3+2]=z*14
  }
}

function toText(str){
  const c=document.createElement('canvas')
  c.width=1400; c.height=360
  const ctx=c.getContext('2d')
  ctx.fillStyle="#000"; ctx.fillRect(0,0,c.width,c.height)
  ctx.fillStyle="#fff"
  ctx.font="52px Playfair Display"
  ctx.textAlign="center"
  ctx.textBaseline="middle"
  wrap(ctx,str,c.width/2,c.height/2,1300,60)

  const d=ctx.getImageData(0,0,c.width,c.height).data
  let ptr=0
  for(let y=0;y<c.height;y+=2){
    for(let x=0;x<c.width;x+=2){
      const id=(y*c.width+x)*4
      if(d[id]>200 && ptr<COUNT){
        target[ptr*3]=x-c.width/2
        target[ptr*3+1]=c.height/2-y
        target[ptr*3+2]=(Math.random()-.5)*60
        ptr++
      }
    }
  }
  for(;ptr<COUNT;ptr++){
    target[ptr*3]=galaxy[ptr*3]
    target[ptr*3+1]=galaxy[ptr*3+1]
    target[ptr*3+2]=galaxy[ptr*3+2]
  }
}

function wrap(ctx,text,x,y,maxWidth,lineHeight){
  const words=text.split(" ")
  let line="",yy=y
  for(let i=0;i<words.length;i++){
    const test=line+words[i]+" "
    if(ctx.measureText(test).width>maxWidth){
      ctx.fillText(line,x,yy)
      line=words[i]+" "
      yy+=lineHeight
    }else line=test
  }
  ctx.fillText(line,x,yy)
}

/* ================= GESTURE ================= */
const info=document.getElementById('gestureInfo')
let buf=[],last=null

function pushGesture(g){
  const now=performance.now()
  buf.push({g,now})
  buf=buf.filter(v=>now-v.now<350)
  const m={}
  buf.forEach(v=>m[v.g]=(m[v.g]||0)+1)
  let best=null,max=0
  for(const k in m){ if(m[k]>max){max=m[k];best=k} }
  return max>=8 && best!==last ? (last=best,best) : null
}

function showGesture(t){
  info.textContent="Gesture detected: "+t
  info.style.opacity=1
  clearTimeout(info._t)
  info._t=setTimeout(()=>info.style.opacity=0,1500)
}

function applyGesture(g){
  showGesture(g)
  if(g==="1")toText(`Dear Laily Aliyah,

I want to sincerely apologize for the situation that happened. Iâ€™m truly sorry if everything made you feel disappointed, confused, or hurt. What hurts me the most is knowing that you thought I was lying, even though I was being honest from the beginning.`)
  else if(g==="2")toText(`I never intended to deceive you or break your trust in any way. I understand why you might have felt that way, and I respect your feelings. Still, I hope one day you can believe that my words were genuine and came from a sincere place.`)
  else if(g==="3")toText(`Iâ€™m really sorry for the misunderstanding, and I truly hope we can clear things up and move forward with honesty and respect.`)
  else if(g==="4")toHeart()
  else if(g==="5")toText("ilysm ly â™¥")
  else if(g==="fist")toText("from: Raja Iblis")
}

/* ================= CAMERA ================= */
const overlay=document.getElementById('overlay')
const statusEl=document.getElementById('status')
const video=document.getElementById('video')
const camBox=document.getElementById('camBox')
const music=document.getElementById('music')

let started=false,hands,cam

function startExperience(){
  if(started) return
  started=true
  overlay.style.display="none"

  music.play().then(()=>music.volume=.35).catch(()=>{})

  requestCamera()
}

/* ðŸ”´ FIX UTAMA: overlay ONCLICK LANGSUNG */
overlay.onclick=startExperience
document.body.onclick=startExperience

async function requestCamera(){
  statusEl.textContent="CAMERA: REQUESTING"
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:false})
    video.srcObject=stream
    await video.play()
    statusEl.textContent="CAMERA: LIVE"
    camBox.style.display="block"
    startHands()
  }catch(e){
    statusEl.textContent="CAMERA: DENIED"
    setTimeout(requestCamera,3000)
  }
}

function startHands(){
  hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`})
  hands.setOptions({maxNumHands:1,minDetectionConfidence:.6,minTrackingConfidence:.6})
  hands.onResults(r=>{
    if(!r.multiHandLandmarks){ toGalaxy(); return }
    const lm=r.multiHandLandmarks[0]
    const tips=[8,12,16,20]
    let c=0
    tips.forEach(i=>{ if(lm[i].y<lm[i-2].y)c++ })
    const g=c===0?"fist":String(c)
    const v=pushGesture(g)
    if(v)applyGesture(v)
  })
  cam=new Camera(video,{onFrame:async()=>hands.send({image:video})})
  cam.start()
}
</script>
</body>
</html>
