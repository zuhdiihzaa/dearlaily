<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cosmic Letter</title>

<style>
html,body{
  margin:0;
  background:black;
  overflow:hidden;
}
canvas{position:fixed;top:0;left:0}

video{
  position:fixed;
  bottom:12px;
  right:12px;
  width:110px;
  border-radius:12px;
  opacity:.75;
  transform:scaleX(-1);
}
</style>
</head>
<body>

<canvas id="c"></canvas>
<video id="cam" autoplay playsinline></video>

<script>
/* ================= BASIC SETUP ================= */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
function resize(){
  canvas.width=innerWidth;
  canvas.height=innerHeight;
}
resize(); addEventListener("resize",resize);

/* ================= CAMERA (HAND ONLY) ================= */
const video=document.getElementById("cam");
navigator.mediaDevices.getUserMedia({video:true})
.then(s=>video.srcObject=s);

/* ================= STAR PARTICLES ================= */
const STAR_COUNT = 1200;
const stars=[];
for(let i=0;i<STAR_COUNT;i++){
  stars.push({
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height,
    z:Math.random()*1,
    tx:null, ty:null,
    a:Math.random()*Math.PI*2
  });
}

/* ================= DRAW ================= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  stars.forEach(s=>{
    s.a+=0.002;
    if(s.tx!==null){
      s.x += (s.tx-s.x)*0.08;
      s.y += (s.ty-s.y)*0.08;
    }else{
      s.x += Math.cos(s.a)*0.15;
      s.y += Math.sin(s.a)*0.15;
    }

    const size = 1.2 + s.z*1.8;
    ctx.fillStyle=`rgba(180,220,255,0.85)`;
    ctx.beginPath();
    ctx.arc(s.x,s.y,size,0,Math.PI*2);
    ctx.fill();
  });

  requestAnimationFrame(draw);
}
draw();

/* ================= TEXT TO STARS ================= */
function textToStars(text){
  const off=document.createElement("canvas");
  const octx=off.getContext("2d");
  off.width=canvas.width;
  off.height=canvas.height;

  octx.fillStyle="white";
  octx.font=`bold ${Math.min(canvas.width/14,64)}px Georgia`;
  octx.textAlign="center";
  octx.textBaseline="middle";

  const lines=text.split("\n");
  lines.forEach((l,i)=>{
    octx.fillText(l,off.width/2,off.height/2+i*70);
  });

  const img=octx.getImageData(0,0,off.width,off.height).data;
  const pts=[];
  for(let y=0;y<off.height;y+=6){
    for(let x=0;x<off.width;x+=6){
      if(img[(y*off.width+x)*4]>200){
        pts.push({x,y});
      }
    }
  }

  stars.forEach((s,i)=>{
    const p=pts[i%pts.length];
    s.tx=p.x;
    s.ty=p.y;
  });
}

/* ================= RELEASE ================= */
function releaseStars(){
  stars.forEach(s=>{
    s.tx=null;
    s.ty=null;
  });
}

/* ================= MESSAGES ================= */
const MESSAGE_OPEN =
`Dear Laily Aliyah,
I want to sincerely apologize for the situation that happened.
I was honest from the beginning,
and my words came from a sincere place.`;

const MESSAGE_FIST =
`ilysm ly â™¥
from: Raja Iblis`;

/* ================= HAND DETECTION (NO FACE) ================= */
const off=document.createElement("canvas");
const offCtx=off.getContext("2d");
off.width=160; off.height=120;

let last=null;
let stable=0;
let mode="idle";

setInterval(()=>{
  if(video.videoWidth===0)return;
  offCtx.drawImage(video,0,0,off.width,off.height);
  const d=offCtx.getImageData(0,0,off.width,off.height).data;

  if(last){
    let diff=0, bright=0;
    for(let i=0;i<d.length;i+=4){
      diff+=Math.abs(d[i]-last[i]);
      bright+=d[i];
    }

    if(diff>260000){
      stable++;
      if(stable>6){
        if(bright/ (d.length/4) > 110 && mode!=="open"){
          mode="open";
          textToStars(MESSAGE_OPEN);
        }
        if(bright/ (d.length/4) <=110 && mode!=="fist"){
          mode="fist";
          textToStars(MESSAGE_FIST);
        }
      }
    }else{
      stable=0;
    }
  }
  last=d;
},200);
</script>
</body>
</html>
