<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Dear Laily</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:black;
  overflow:hidden;
  font-family:serif;
}
#status{
  position:fixed;
  bottom:10px;
  left:10px;
  font-size:12px;
  color:#9ab6ff;
  z-index:10;
}
#cam{
  position:fixed;
  top:10px;
  right:10px;
  width:120px;
  aspect-ratio:1/1;
  border-radius:14px;
  overflow:hidden;
  border:2px dashed rgba(255,255,255,.4);
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
}
</style>
</head>

<body>
<div id="cam"><video id="video" autoplay playsinline muted></video></div>
<div id="status">initializing</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<script>
/* =========================
   ORIENTATION (BEST EFFORT)
========================= */
if(screen.orientation && screen.orientation.lock){
  screen.orientation.lock("portrait").catch(()=>{});
}

const IS_MOBILE = innerWidth < 768;

/* =========================
   THREE SETUP
========================= */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  60,
  innerWidth/innerHeight,
  0.1,
  1000
);
camera.position.z = 42;

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
document.body.appendChild(renderer.domElement);

/* =========================
   ROUND STAR TEXTURE
========================= */
const c=document.createElement("canvas");
c.width=c.height=64;
const ctx=c.getContext("2d");
const g=ctx.createRadialGradient(32,32,4,32,32,32);
g.addColorStop(0,"white");
g.addColorStop(1,"transparent");
ctx.fillStyle=g;
ctx.beginPath();
ctx.arc(32,32,32,0,Math.PI*2);
ctx.fill();
const starTex=new THREE.CanvasTexture(c);

/* =========================
   PARTICLES
========================= */
const COUNT=3000;
const geo=new THREE.BufferGeometry();
const pos=new Float32Array(COUNT*3);
const base=new Float32Array(COUNT*3);

for(let i=0;i<COUNT;i++){
  const i3=i*3;
  pos[i3]=(Math.random()-0.5)*100;
  pos[i3+1]=(Math.random()-0.5)*120;
  pos[i3+2]=(Math.random()-0.5)*80;
  base.set(pos.slice(i3,i3+3),i3);
}
geo.setAttribute("position",new THREE.BufferAttribute(pos,3));

const mat=new THREE.PointsMaterial({
  map:starTex,
  transparent:true,
  depthWrite:false,
  size:0.9
});
const points=new THREE.Points(geo,mat);
scene.add(points);

/* =========================
   TEXT TARGET (PORTRAIT)
========================= */
function makeText(text){
  const tc=document.createElement("canvas");
  tc.width=600;
  tc.height=300;
  const tctx=tc.getContext("2d");
  tctx.fillStyle="white";
  tctx.textAlign="center";
  tctx.font="56px serif";
  tctx.fillText(text, tc.width/2, tc.height/2+20);

  const d=tctx.getImageData(0,0,tc.width,tc.height).data;
  const arr=[];
  const scale=0.22;

  for(let y=0;y<tc.height;y+=3){
    for(let x=0;x<tc.width;x+=3){
      if(d[(y*tc.width+x)*4+3]>150){
        arr.push({
          x:(x-tc.width/2)*scale,
          y:(tc.height/2-y)*scale,
          z:0
        });
      }
    }
  }
  return arr;
}

const TEXT_TARGET = makeText("Dear Laily");
let showText=false;

/* =========================
   MEDIAPIPE
========================= */
const video=document.getElementById("video");
const status=document.getElementById("status");

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

let handVisible=false;
let lastHandTime=0;

hands.onResults(r=>{
  if(r.multiHandLandmarks && r.multiHandLandmarks.length){
    handVisible=true;
    lastHandTime=performance.now();
    status.textContent="detecting";

    const lm=r.multiHandLandmarks[0];
    const up=(t,p)=>lm[t].y<lm[p].y;
    let fingers=0;
    if(up(8,6))fingers++;
    if(up(12,10))fingers++;
    if(up(16,14))fingers++;
    if(up(20,18))fingers++;

    showText = (fingers===1);
  }
});

/* =========================
   CAMERA LOOP (ANTI-DEAD)
========================= */
let busy=false;

const cam=new Camera(video,{
  onFrame: async ()=>{
    if(busy) return;
    busy=true;
    try{
      await hands.send({image:video});
    }catch(e){}
    busy=false;
  },
  width:640,
  height:640
});
cam.start();

/* =========================
   ANIMATE
========================= */
function animate(){
  requestAnimationFrame(animate);

  if(handVisible && performance.now()-lastHandTime>1500){
    handVisible=false;
    showText=false;
    status.textContent="idle";
  }

  const p=geo.attributes.position.array;
  for(let i=0;i<COUNT;i++){
    const i3=i*3;
    let tx,ty,tz;
    if(showText && i<TEXT_TARGET.length){
      ({x:tx,y:ty,z:tz}=TEXT_TARGET[i]);
    }else{
      tx=base[i3];ty=base[i3+1];tz=base[i3+2];
    }
    p[i3]+= (tx-p[i3])*0.09;
    p[i3+1]+= (ty-p[i3+1])*0.09;
    p[i3+2]+= (tz-p[i3+2])*0.09;
  }
  geo.attributes.position.needsUpdate=true;
  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
