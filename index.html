<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Dear Laily</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:black;
  overflow:hidden;
  font-family:serif;
}
#debug{
  position:fixed;
  bottom:10px;
  left:10px;
  color:#7aa2ff;
  font-size:12px;
  z-index:10;
}
#cameraBox{
  position:fixed;
  top:10px;
  right:10px;
  width:150px;
  aspect-ratio:1/1;
  border-radius:14px;
  overflow:hidden;
  border:2px dashed rgba(255,255,255,.4);
  z-index:5;
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
  transform: scaleX(1); /* ❗️TIDAK MIRROR */
}
</style>
</head>

<body>
<div id="cameraBox">
  <video id="video" autoplay playsinline></video>
</div>
<div id="debug">gesture: idle</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<script>
/* =====================
   THREE BASIC
===================== */
const scene = new THREE.Scene();
const camera3D = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
camera3D.position.z = 60;

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
document.body.appendChild(renderer.domElement);

/* =====================
   STAR TEXTURE (BULAT)
===================== */
const starCanvas = document.createElement("canvas");
starCanvas.width = starCanvas.height = 64;
const sctx = starCanvas.getContext("2d");
const grad = sctx.createRadialGradient(32,32,2,32,32,32);
grad.addColorStop(0,"white");
grad.addColorStop(1,"transparent");
sctx.fillStyle = grad;
sctx.beginPath();
sctx.arc(32,32,32,0,Math.PI*2);
sctx.fill();

const starTexture = new THREE.CanvasTexture(starCanvas);

/* =====================
   STARS
===================== */
const COUNT = 1500;
const geo = new THREE.BufferGeometry();
const pos = new Float32Array(COUNT*3);
const basePos = new Float32Array(COUNT*3);

for(let i=0;i<COUNT;i++){
  const i3=i*3;
  pos[i3]=(Math.random()-0.5)*120;
  pos[i3+1]=(Math.random()-0.5)*120;
  pos[i3+2]=(Math.random()-0.5)*120;
  basePos.set(pos.slice(i3,i3+3), i3);
}
geo.setAttribute("position", new THREE.BufferAttribute(pos,3));

const mat = new THREE.PointsMaterial({
  map: starTexture,
  transparent:true,
  depthWrite:false,
  size:0.8,
  sizeAttenuation:true
});

const stars = new THREE.Points(geo, mat);
scene.add(stars);

/* =====================
   TEXT TARGET (DEAR LAILY)
===================== */
function generateTextTargets(text, scale=0.35){
  const c=document.createElement("canvas");
  c.width=800; c.height=200;
  const ctx=c.getContext("2d");
  ctx.fillStyle="white";
  ctx.textAlign="center";
  ctx.font="72px serif";
  ctx.fillText(text, c.width/2, c.height/2+20);

  const d=ctx.getImageData(0,0,c.width,c.height).data;
  const t=[];
  for(let y=0;y<c.height;y+=4){
    for(let x=0;x<c.width;x+=4){
      if(d[(y*c.width+x)*4+3]>150){
        t.push({
          x:(x-c.width/2)*scale,
          y:(c.height/2-y)*scale,
          z:0
        });
      }
    }
  }
  return t;
}

const TARGET_TEXT = generateTextTargets("Dear Laily");
let showText = false;

/* =====================
   MEDIAPIPE HANDS
===================== */
const video = document.getElementById("video");
const debug = document.getElementById("debug");

const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

let lastCount=-1, startTime=0;
const HOLD=700;

hands.onResults(r=>{
  if(!r.multiHandLandmarks){
    showText=false;
    debug.textContent="gesture: idle";
    return;
  }

  const lm=r.multiHandLandmarks[0];
  const up=(t,p)=>lm[t].y<lm[p].y;

  let count=0;
  if(up(8,6))count++;
  if(up(12,10))count++;
  if(up(16,14))count++;
  if(up(20,18))count++;

  const now=performance.now();
  if(count!==lastCount){
    lastCount=count;
    startTime=now;
  }else if(now-startTime>HOLD){
    showText = (count===1);
  }

  debug.textContent = showText ? "gesture: 1 finger" : "gesture: detecting";
});

new Camera(video,{
  onFrame:async()=>{await hands.send({image:video});},
  width:480,height:480
}).start();

/* =====================
   ANIMATION LOOP
===================== */
function animate(){
  requestAnimationFrame(animate);
  const p=geo.attributes.position.array;

  for(let i=0;i<COUNT;i++){
    const i3=i*3;
    let tx,ty,tz;

    if(showText && i<TARGET_TEXT.length){
      ({x:tx,y:ty,z:tz}=TARGET_TEXT[i]);
    }else{
      tx=basePos[i3];
      ty=basePos[i3+1];
      tz=basePos[i3+2];
    }

    p[i3]+= (tx-p[i3])*0.08;
    p[i3+1]+= (ty-p[i3+1])*0.08;
    p[i3+2]+= (tz-p[i3+2])*0.08;
  }

  geo.attributes.position.needsUpdate=true;
  renderer.render(scene,camera3D);
}
animate();
</script>
</body>
</html>
