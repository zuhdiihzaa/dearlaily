<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cosmic Gesture Message</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <!-- Google Font (romantic) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital@0;1&family=Great+Vibes&display=swap" rel="stylesheet">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      overflow: hidden;
      font-family: 'Playfair Display', serif;
      color: white;
      height: 100%;
    }

    #container {
      position: fixed;
      inset: 0;
    }

    canvas {
      display: block;
    }

    /* Overlay start */
    #startOverlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at center, #1b0033, #000);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      text-align: center;
      padding: 20px;
    }

    #startOverlay button {
      font-size: 1.1rem;
      padding: 16px 28px;
      border-radius: 40px;
      border: none;
      background: linear-gradient(135deg, #ff9ad5, #b084ff);
      color: #000;
      cursor: pointer;
      box-shadow: 0 0 25px rgba(255,180,255,0.6);
    }

    /* Camera POV */
    #cameraBox {
      position: fixed;
      bottom: 12px;
      right: 12px;
      width: 120px;
      height: 160px;
      border-radius: 14px;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.4);
      box-shadow: 0 0 15px rgba(180,150,255,0.6);
      z-index: 5;
      background: #000;
    }

    #cameraBox video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }

    #cameraGuide {
      position: absolute;
      inset: 12px;
      border: 1px dashed rgba(255,255,255,0.6);
      border-radius: 10px;
      pointer-events: none;
    }

    #gestureStatus {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.9rem;
      opacity: 0.8;
      z-index: 5;
    }
  </style>
</head>
<body>

<div id="container"></div>

<div id="gestureStatus">Detecting...</div>

<div id="cameraBox">
  <video id="video" playsinline></video>
  <div id="cameraGuide"></div>
</div>

<div id="startOverlay">
  <div>
    <h2>✨ Tap to Start ✨</h2>
    <p>Aktifkan kamera & audio<br>Arahkan tangan ke tengah kamera</p>
    <button id="startBtn">Start Experience</button>
  </div>
</div>

<!-- Audio -->
<audio id="bgm" loop>
  <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_4c3c3a1f1a.mp3" type="audio/mpeg">
</audio>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<script>
/* =====================
   THREE.JS SCENE
===================== */
let scene, camera, renderer, particles, geometry;
const container = document.getElementById('container');

scene = new THREE.Scene();

camera = new THREE.PerspectiveCamera(
  60,
  window.innerWidth / window.innerHeight,
  1,
  2000
);
camera.position.z = 400;

renderer = new THREE.WebGLRenderer({ antialias: false });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
renderer.setSize(window.innerWidth, window.innerHeight);
container.appendChild(renderer.domElement);

// Stars
const STAR_COUNT = window.innerWidth < 768 ? 1200 : 3000;
geometry = new THREE.BufferGeometry();
const positions = new Float32Array(STAR_COUNT * 3);

for (let i = 0; i < STAR_COUNT; i++) {
  positions[i * 3] = (Math.random() - 0.5) * 1000;
  positions[i * 3 + 1] = (Math.random() - 0.5) * 1000;
  positions[i * 3 + 2] = (Math.random() - 0.5) * 1000;
}

geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

const material = new THREE.PointsMaterial({
  color: 0xffffff,
  size: 1.5,
  transparent: true,
  opacity: 0.8,
  blending: THREE.AdditiveBlending
});

particles = new THREE.Points(geometry, material);
scene.add(particles);

function animate() {
  requestAnimationFrame(animate);
  particles.rotation.y += 0.0004;
  renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

/* =====================
   PARTICLE MORPH TEXT
===================== */
function morphToText(text) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  canvas.width = 800;
  canvas.height = 300;

  ctx.fillStyle = 'black';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.font = 'italic 42px Playfair Display';
  ctx.fillStyle = 'white';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';

  const lines = text.split('\n');
  lines.forEach((line, i) => {
    ctx.fillText(line, canvas.width/2, canvas.height/2 + i*48);
  });

  const img = ctx.getImageData(0,0,canvas.width,canvas.height).data;
  const target = geometry.attributes.position.array;

  let ptr = 0;
  for (let y=0; y<canvas.height; y+=4) {
    for (let x=0; x<canvas.width; x+=4) {
      const index = (y * canvas.width + x) * 4;
      if (img[index] > 10 && ptr < STAR_COUNT) {
        target[ptr*3]   = x - canvas.width/2;
        target[ptr*3+1] = canvas.height/2 - y;
        target[ptr*3+2] = 0;
        ptr++;
      }
    }
  }
  geometry.attributes.position.needsUpdate = true;
}

function resetGalaxy() {
  const arr = geometry.attributes.position.array;
  for (let i = 0; i < STAR_COUNT; i++) {
    arr[i*3]   = (Math.random() - 0.5) * 1000;
    arr[i*3+1] = (Math.random() - 0.5) * 1000;
    arr[i*3+2] = (Math.random() - 0.5) * 1000;
  }
  geometry.attributes.position.needsUpdate = true;
}

/* =====================
   HAND TRACKING
===================== */
let lastGesture = null;
let lastTime = 0;

const video = document.getElementById('video');
const statusText = document.getElementById('gestureStatus');

const hands = new Hands({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 0,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.6,
  selfieMode: true
});

hands.onResults(results => {
  if (!results.multiHandLandmarks) {
    statusText.textContent = 'Detecting...';
    resetGalaxy();
    lastGesture = null;
    return;
  }

  const lm = results.multiHandLandmarks[0];
  const fingers =
    (lm[8].y < lm[6].y) +
    (lm[12].y < lm[10].y) +
    (lm[16].y < lm[14].y) +
    (lm[20].y < lm[18].y);

  let gesture = 'fist';
  if (fingers === 1) gesture = 'one';
  if (fingers === 2) gesture = 'two';
  if (fingers === 3) gesture = 'three';
  if (fingers === 4) gesture = 'four';
  if (fingers === 5) gesture = 'five';

  const now = Date.now();
  if (gesture !== lastGesture && now - lastTime > 800) {
    lastGesture = gesture;
    lastTime = now;
    triggerGesture(gesture);
  }

  statusText.textContent = 'Detected: ' + gesture;
});

function triggerGesture(g) {
  if (g === 'one') {
    morphToText(`Dear Laily Aliyah,\n\nI want to sincerely apologize for the situation that happened. I’m truly sorry if everything made you feel disappointed, confused, or hurt. What hurts me the most is knowing that you thought I was lying, even though I was being honest from the beginning.`);
  }
  if (g === 'two') {
    morphToText(`I never intended to deceive you or break your trust in any way. I understand why you might have felt that way, and I respect your feelings. Still, I hope one day you can believe that my words were genuine and came from a sincere place.`);
  }
  if (g === 'three') {
    morphToText(`I’m really sorry for the misunderstanding, and I truly hope we can clear things up and move forward with honesty and respect.`);
  }
  if (g === 'five') {
    morphToText(`ilysm ly ♥`);
  }
  if (g === 'fist') {
    morphToText(`from: Raja Iblis`);
  }
}

/* =====================
   START EXPERIENCE
===================== */
document.getElementById('startBtn').onclick = async () => {
  document.getElementById('startOverlay').style.display = 'none';
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: 'user', width: 640, height: 480 }
  });
  video.srcObject = stream;
  await video.play();

  const cam = new Camera(video, {
    onFrame: async () => {
      await hands.send({ image: video });
    },
    width: 640,
    height: 480
  });
  cam.start();

  document.getElementById('bgm').play();
};
</script>
</body>
</html>
