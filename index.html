<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>Dear Laily â€” Gesture Test</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: radial-gradient(ellipse at bottom, #07001a 0%, #000000 70%);
}
canvas { display: block; }

#camera-box {
  position: fixed;
  top: 14px;
  right: 14px;
  width: 140px;
  height: 190px;
  border-radius: 14px;
  overflow: hidden;
  background: #000;
  box-shadow: 0 0 20px rgba(120,80,255,0.35);
  border: 1px solid rgba(180,140,255,0.35);
  z-index: 10;
}
#camera-box video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transform: scaleX(-1);
}
#camera-guide {
  position: absolute;
  inset: 10px;
  border: 1px dashed rgba(255,255,255,0.45);
  border-radius: 10px;
}
#camera-dot {
  position: absolute;
  width: 6px;
  height: 6px;
  background: rgba(255,255,255,0.8);
  border-radius: 50%;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
#debug {
  position: fixed;
  left: 14px;
  bottom: 14px;
  font-family: monospace;
  font-size: 12px;
  color: #9bb0ff;
  z-index: 10;
}
</style>
</head>

<body>

<div id="camera-box">
  <video id="camera" autoplay playsinline muted></video>
  <div id="camera-guide"></div>
  <div id="camera-dot"></div>
</div>
<div id="debug">gesture: none</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* =========================
   CAMERA STREAM
========================= */
const video = document.getElementById("camera");
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "user" },
  audio: false
}).then(stream => video.srcObject = stream);

/* =========================
   MEDIAPIPE HANDS
========================= */
const hands = new Hands({
  locateFile: file =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 0,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});

const debug = document.getElementById("debug");

let lastGesture = "none";
let stableGesture = "none";
let gestureStartTime = 0;
const HOLD_TIME = 800; // ms

hands.onResults(results => {
  if (
    !results.multiHandLandmarks ||
    !results.multiHandedness ||
    results.multiHandLandmarks.length === 0
  ) {
    lastGesture = "none";
    stableGesture = "none";
    debug.textContent = "gesture: idle";
    return;
  }

  const lm = results.multiHandLandmarks[0];
  const handedness = results.multiHandedness[0].label;
  const now = performance.now();

  const isUp = (tip, pip) => lm[tip].y < lm[pip].y;

  const thumbUp =
    handedness === "Right"
      ? lm[4].x < lm[3].x
      : lm[4].x > lm[3].x;

  const indexUp  = isUp(8, 6);
  const middleUp = isUp(12,10);
  const ringUp   = isUp(16,14);
  const pinkyUp  = isUp(20,18);

  let currentGesture = "unknown";

  // ===== PRIORITY RULES =====
  if (!indexUp && !middleUp && !ringUp && !pinkyUp) {
    currentGesture = "fist";
  }
  else if (indexUp && middleUp && !ringUp && !pinkyUp) {
    currentGesture = "2 fingers";
  }
  else {
    let count = 0;
    if (thumbUp) count++;
    if (indexUp) count++;
    if (middleUp) count++;
    if (ringUp) count++;
    if (pinkyUp) count++;

    if (count === 1) currentGesture = "1 finger";
    else if (count === 3) currentGesture = "3 fingers";
    else if (count === 4) currentGesture = "4 fingers";
    else if (count === 5) currentGesture = "5 fingers";
  }

  // ===== STABILIZER =====
  if (currentGesture !== lastGesture) {
    lastGesture = currentGesture;
    gestureStartTime = now;
    stableGesture = "none";
  } else {
    if (now - gestureStartTime > HOLD_TIME) {
      stableGesture = currentGesture;
    }
  }

  debug.textContent =
    stableGesture !== "none"
      ? `gesture: ${stableGesture}`
      : "gesture: detecting...";
});


/* =========================
   CAMERA UTILS LOOP
========================= */
const cam = new Camera(video, {
  onFrame: async () => {
    await hands.send({ image: video });
  },
  width: 640,
  height: 480
});
cam.start();

/* =========================
   THREE SCENE (IDLE ONLY)
========================= */
const scene = new THREE.Scene();
const camera3D = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 0.1, 1000);
camera3D.position.z = 120;
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 1.5));
document.body.appendChild(renderer.domElement);

const stars = new THREE.Points(
  new THREE.BufferGeometry(),
  new THREE.PointsMaterial({ size: 1 })
);
scene.add(stars);

function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera3D);
}
animate();
</script>
</body>
</html>
