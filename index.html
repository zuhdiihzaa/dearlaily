<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
<title>Cinematic Galaxy Gesture – Stable</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">

<style>
html,body{
  margin:0;height:100%;overflow:hidden;
  background:#000;font-family:'Playfair Display',serif;
}
#start{
  position:fixed;inset:0;display:flex;
  align-items:center;justify-content:center;
  color:#fff;font-size:22px;z-index:10;
  background:#000;cursor:pointer;
}
#indicator{
  position:fixed;bottom:16px;left:50%;
  transform:translateX(-50%);
  color:#fff;font-size:14px;
  opacity:0;transition:opacity .4s;
  pointer-events:none;z-index:5;
}
#camBox{
  position:fixed;right:10px;bottom:10px;
  width:130px;height:180px;
  border:1px solid rgba(255,255,255,.4);
  border-radius:8px;overflow:hidden;
  display:none;z-index:4;
}
#camBox video{
  width:100%;height:100%;object-fit:cover;
  transform:scaleX(-1);
}
#camBox span{
  position:absolute;bottom:4px;left:0;right:0;
  text-align:center;font-size:10px;
  color:#fff;opacity:.7;
}
canvas{display:block}
</style>
</head>
<body>

<div id="start">Tap anywhere to start</div>
<div id="indicator"></div>
<div id="camBox">
  <video id="cam" autoplay muted playsinline></video>
  <span>Place your hand in the center</span>
</div>

<audio id="music" loop preload="auto">
  <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_8b1e76a7b3.mp3?filename=space-ambient-110997.mp3" type="audio/mpeg">
</audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<script>
/* ================= START ================= */
const start=document.getElementById('start')
const camBox=document.getElementById('camBox')
const indicator=document.getElementById('indicator')
const music=document.getElementById('music')
const video=document.getElementById('cam')
let started=false

start.onclick=async()=>{
  start.style.display='none'
  camBox.style.display='block'
  started=true
  try{await music.play();music.volume=.35}catch(e){}
  initCamera()
}

/* ================= THREE CORE ================= */
const scene=new THREE.Scene()
scene.fog=new THREE.FogExp2(0x050510,.002)

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,1000)
camera.position.z=120

const renderer=new THREE.WebGLRenderer({antialias:true})
renderer.setSize(innerWidth,innerHeight)
renderer.setPixelRatio(Math.min(devicePixelRatio,2))
document.body.appendChild(renderer.domElement)

/* ================= PARTICLES ================= */
const COUNT=12000
const pos=new Float32Array(COUNT*3)
const galaxy=new Float32Array(COUNT*3)
const target=new Float32Array(COUNT*3)

for(let i=0;i<COUNT;i++){
  const r=Math.random()*70
  const a=Math.random()*Math.PI*2
  galaxy[i*3]=Math.cos(a)*r
  galaxy[i*3+1]=(Math.random()-.5)*30
  galaxy[i*3+2]=Math.sin(a)*r
  pos.set(galaxy.slice(i*3,i*3+3),i*3)
  target.set(galaxy.slice(i*3,i*3+3),i*3)
}

const geo=new THREE.BufferGeometry()
geo.setAttribute('position',new THREE.BufferAttribute(pos,3))

const mat=new THREE.PointsMaterial({
  color:0xcfe6ff,size:1.2,
  transparent:true,opacity:.9,
  depthWrite:false
})

const points=new THREE.Points(geo,mat)
scene.add(points)

/* ================= STATE MACHINE ================= */
const STATE={IDLE:0,TRANSITION:1,DISPLAY:2}
let state=STATE.IDLE
let activeGesture=null
let morphT=0
let morphDur=2

/* ================= TARGET BUILDERS ================= */
function buildText(text){
  const chars=[...text]
  for(let i=0;i<COUNT;i++){
    const c=i%chars.length
    target[i*3]=(c-chars.length/2)*2.2
    target[i*3+1]=Math.sin(i*.12)*4
    target[i*3+2]=(Math.floor(i/chars.length)%10-5)*2
  }
}

function buildHeart(){
  for(let i=0;i<COUNT;i++){
    const t=Math.random()*Math.PI*2
    const r=18*(1-Math.sin(t))
    target[i*3]=r*Math.cos(t)
    target[i*3+1]=r*Math.sin(t)
    target[i*3+2]=(Math.random()-.5)*6
  }
}

function toGalaxy(){
  target.set(galaxy)
  morphT=0
  state=STATE.TRANSITION
  activeGesture=null
}

/* ================= APPLY GESTURE ================= */
function applyGesture(g){
  morphT=0
  morphDur=1.5+Math.random()
  state=STATE.DISPLAY
  activeGesture=g

  if(g===1)buildText(`Dear Laily Aliyah,
I want to sincerely apologize for the situation that happened. I’m truly sorry if everything made you feel disappointed, confused, or hurt. What hurts me the most is knowing that you thought I was lying, even though I was being honest from the beginning.`)

  if(g===2)buildText(`I never intended to deceive you or break your trust in any way. I understand why you might have felt that way, and I respect your feelings. Still, I hope one day you can believe that my words were genuine and came from a sincere place.`)

  if(g===3)buildText(`I’m really sorry for the misunderstanding, and I truly hope we can clear things up and move forward with honesty and respect.`)

  if(g===4)buildHeart()
  if(g===5)buildText(`ilysm ly ♥`)
  if(g==="fist")buildText(`from: Raja Iblis`)

  indicator.textContent=`Gesture detected: ${g}`
  indicator.style.opacity=1
  setTimeout(()=>indicator.style.opacity=0,700)
}

/* ================= GESTURE STABILIZER ================= */
let buffer=[]
let stable=null
let stableSince=0
const WINDOW=12
const STABLE_MS=300

function pushGesture(g){
  buffer.push(g)
  if(buffer.length>WINDOW)buffer.shift()
  if(buffer.every(v=>v===buffer[0])){
    if(stable!==buffer[0]){
      stable=buffer[0]
      stableSince=performance.now()
    }
    if(performance.now()-stableSince>=STABLE_MS){
      return stable
    }
  }
  return null
}

/* ================= MEDIAPIPE ================= */
function initCamera(){
  const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`})
  hands.setOptions({
    maxNumHands:1,
    minDetectionConfidence:.6,
    minTrackingConfidence:.6
  })

  hands.onResults(res=>{
    if(!res.multiHandLandmarks){
      if(state===STATE.DISPLAY)toGalaxy()
      return
    }
    const lm=res.multiHandLandmarks[0]
    const tips=[4,8,12,16,20]
    let fingers=0
    for(let i=1;i<tips.length;i++){
      if(lm[tips[i]].y<lm[tips[i]-2].y)fingers++
    }
    if(fingers===0)fingers="fist"

    const valid=pushGesture(fingers)
    if(valid!==null && valid!==activeGesture){
      applyGesture(valid)
    }
  })

  const cam=new Camera(video,{
    onFrame:async()=>{await hands.send({image:video})},
    width:640,height:480
  })
  cam.start()
}

/* ================= ANIMATION LOOP ================= */
let mouseX=0,mouseY=0
window.onmousemove=e=>{
  mouseX=(e.clientX/innerWidth-.5)*2
  mouseY=(e.clientY/innerHeight-.5)*2
}

function animate(t){
  requestAnimationFrame(animate)

  // galaxy idle motion
  for(let i=0;i<COUNT;i++){
    galaxy[i*3]+=Math.sin(t*.0002+i)*.002
    galaxy[i*3+2]+=Math.cos(t*.0002+i)*.002
  }

  // morph interpolation
  morphT=Math.min(morphT+1/60/morphDur,1)
  const e=morphT<.5
    ?4*morphT*morphT*morphT
    :1-Math.pow(-2*morphT+2,3)/2

  for(let i=0;i<COUNT*3;i++){
    pos[i]+= (target[i]-pos[i])*e
  }
  geo.attributes.position.needsUpdate=true

  // breathing + parallax
  points.scale.setScalar(1+.02*Math.sin(t*.002))
  points.rotation.y+=.0004
  camera.position.x+= (mouseX*10-camera.position.x)*.05
  camera.position.y+= (-mouseY*10-camera.position.y)*.05

  renderer.render(scene,camera)
}
animate(0)

/* ================= RESIZE ================= */
onresize=()=>{
  camera.aspect=innerWidth/innerHeight
  camera.updateProjectionMatrix()
  renderer.setSize(innerWidth,innerHeight)
}
</script>
</body>
</html>
