<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cosmic Gesture Message</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- THREE -->
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/FontLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/geometries/TextGeometry.js"></script>

<!-- MEDIAPIPE HANDS -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>

<style>
html,body{
  margin:0;
  overflow:hidden;
  background:black;
}

#startCam{
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  padding:14px 24px;
  font-size:16px;
  border-radius:14px;
  border:none;
  background:#ff66cc;
  color:white;
  cursor:pointer;
  z-index:20;
}

#camBox{
  position:fixed;
  right:12px;
  bottom:12px;
  width:220px;
  height:160px;
  border-radius:12px;
  overflow:hidden;
  border:2px solid rgba(255,255,255,.7);
  z-index:10;
}

#camBox video{
  width:100%;
  height:100%;
  object-fit:cover;
}

#hint{
  position:absolute;
  top:0;
  width:100%;
  text-align:center;
  font-size:13px;
  color:white;
  background:rgba(0,0,0,.5);
}
</style>
</head>

<body>

<button id="startCam">Aktifkan Kamera</button>

<div id="camBox">
  <div id="hint">Arahkan tangan ke tengah</div>
  <video id="video" playsinline muted></video>
</div>

<script>
/* =========================
   THREE JS
========================= */
const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x000011, 400, 2500);

const camera3D = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 1, 5000);
camera3D.position.z = 700;

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
document.body.appendChild(renderer.domElement);

/* STARS */
const starsGeo = new THREE.BufferGeometry();
const STAR_COUNT = 4000;
const pos = new Float32Array(STAR_COUNT*3);
for(let i=0;i<pos.length;i++) pos[i]=(Math.random()-0.5)*3000;
starsGeo.setAttribute("position", new THREE.BufferAttribute(pos,3));
const stars = new THREE.Points(
  starsGeo,
  new THREE.PointsMaterial({color:0xffffff,size:2})
);
scene.add(stars);

/* LIGHT */
scene.add(new THREE.AmbientLight(0xffccff,0.6));

/* TEXT & HEART */
let font=null, textMesh=null, heartMesh=null;
new THREE.FontLoader().load(
  "https://threejs.org/examples/fonts/helvetiker_regular.typeface.json",
  f=>font=f
);

function clearObjects(){
  if(textMesh){scene.remove(textMesh);textMesh.geometry.dispose();textMesh=null;}
  if(heartMesh){scene.remove(heartMesh);heartMesh.geometry.dispose();heartMesh=null;}
}

function showText(msg){
  if(!font) return;
  clearObjects();
  const geo=new THREE.TextGeometry(msg,{font,size:26,height:6});
  geo.center();
  const mat=new THREE.MeshStandardMaterial({
    color:0xffb6ff,emissive:0x331133
  });
  textMesh=new THREE.Mesh(geo,mat);
  scene.add(textMesh);
}

function showHeart(){
  clearObjects();
  const s=new THREE.Shape();
  s.moveTo(0,30);
  s.bezierCurveTo(0,30,-30,0,-60,0);
  s.bezierCurveTo(-90,0,-90,45,-90,45);
  s.bezierCurveTo(-90,75,-45,105,0,120);
  s.bezierCurveTo(45,105,90,75,90,45);
  s.bezierCurveTo(90,45,90,0,60,0);
  s.bezierCurveTo(30,0,0,30,0,30);

  const geo=new THREE.ExtrudeGeometry(s,{depth:20,bevelEnabled:true});
  const mat=new THREE.MeshStandardMaterial({
    color:0xff3366,emissive:0x440011
  });
  heartMesh=new THREE.Mesh(geo,mat);
  heartMesh.scale.set(2,2,2);
  scene.add(heartMesh);
}

/* ANIMATION */
function animate(){
  requestAnimationFrame(animate);
  stars.rotation.y+=0.00025;
  if(heartMesh) heartMesh.rotation.y+=0.01;
  renderer.render(scene,camera3D);
}
animate();

/* =========================
   MEDIAPIPE HANDS (MANUAL)
========================= */
const video=document.getElementById("video");
const startBtn=document.getElementById("startCam");

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  minDetectionConfidence:0.75,
  minTrackingConfidence:0.75
});

let lastGesture="", cooldown=false;
function trigger(name, action){
  if(cooldown||lastGesture===name) return;
  cooldown=true; lastGesture=name; action();
  setTimeout(()=>cooldown=false,1200);
}

hands.onResults(r=>{
  if(!r.multiHandLandmarks) return;
  const lm=r.multiHandLandmarks[0];

  const index=lm[8].y<lm[6].y;
  const middle=lm[12].y<lm[10].y;
  const ring=lm[16].y<lm[14].y;
  const pinky=lm[20].y<lm[18].y;
  const thumb=Math.abs(lm[4].x-lm[3].x)>0.04;

  if(!index&&!middle&&!ring&&!pinky&&!thumb)
    trigger("fist",()=>showText("from: Raja Iblis"));

  if(index&&middle&&!ring&&!pinky)
    trigger("peace",()=>showText("I never intended to deceive you."));

  if(index&&middle&&ring&&!pinky)
    trigger("three",()=>showText("I’m really sorry for the misunderstanding."));

  if(!thumb&&index&&middle&&ring&&pinky)
    trigger("four",showHeart);

  if(thumb&&index&&middle&&ring&&pinky)
    trigger("five",()=>showText("ilysm ly ♥"));
});

/* CAMERA START (STABLE) */
startBtn.onclick = async () => {
  startBtn.style.display="none";
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
    await video.play();

    async function loop(){
      await hands.send({image:video});
      requestAnimationFrame(loop);
    }
    loop();
  }catch(e){
    alert("Kamera tidak bisa diakses.");
    console.error(e);
  }
};
</script>

</body>
</html>
