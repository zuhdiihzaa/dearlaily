<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cosmic Gesture Message</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display&display=swap" rel="stylesheet">
<style>
html,body{margin:0;padding:0;background:#000;overflow:hidden;font-family:'Playfair Display',serif}
#container{position:fixed;inset:0}
#gestureStatus{position:fixed;top:10px;left:50%;transform:translateX(-50%);color:#fff;font-size:13px;opacity:.8;z-index:5}
#cameraBox{position:fixed;bottom:12px;right:12px;width:120px;height:160px;border-radius:14px;overflow:hidden;border:2px solid rgba(255,255,255,.4);z-index:5}
#cameraBox video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
#startOverlay{position:fixed;inset:0;z-index:10;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle,#220044,#000);color:#fff;text-align:center}
#startOverlay button{padding:16px 28px;border-radius:40px;border:none;background:#fff;font-size:18px;cursor:pointer}
</style>
</head>
<body>

<div id="container"></div>
<div id="gestureStatus">Detecting…</div>

<div id="cameraBox">
 <video id="video" playsinline></video>
</div>

<div id="startOverlay">
 <div>
  <h2>✨ Tap to Start ✨</h2>
  <button id="startBtn">Start</button>
 </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<script>
/* ================= CORE ================= */
const scene=new THREE.Scene();
scene.fog=new THREE.FogExp2(0x050010,0.0012);

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,1,3000);
camera.position.z=500;

const renderer=new THREE.WebGLRenderer({antialias:false});
renderer.setPixelRatio(Math.min(devicePixelRatio,1.5));
renderer.setSize(innerWidth,innerHeight);
document.getElementById("container").appendChild(renderer.domElement);

/* ================= STARS ================= */
const COUNT=innerWidth<768?1500:3200;
const geo=new THREE.BufferGeometry();
const pos=new Float32Array(COUNT*3);
const galaxy=new Float32Array(COUNT*3);
const shape=new Float32Array(COUNT*3);

for(let i=0;i<COUNT;i++){
 galaxy[i*3]=(Math.random()-0.5)*1800;
 galaxy[i*3+1]=(Math.random()-0.5)*1800;
 galaxy[i*3+2]=(Math.random()-0.5)*1800;
 pos.set(galaxy);
 shape.set(galaxy);
}
geo.setAttribute("position",new THREE.BufferAttribute(pos,3));

const stars=new THREE.Points(
 geo,
 new THREE.PointsMaterial({
  color:0xffffff,size:1.8,transparent:true,
  opacity:0.9,blending:THREE.AdditiveBlending
 })
);
scene.add(stars);

/* ================= BLEND ================= */
let blend=0;          // 0 galaxy → 1 shape
let targetBlend=0;

/* ================= MORPH BUILDER ================= */
function buildShape(draw){
 const c=document.createElement("canvas");
 const ctx=c.getContext("2d");
 c.width=innerHeight>innerWidth?380:900;
 c.height=innerHeight>innerWidth?560:420;

 ctx.fillStyle="#000";ctx.fillRect(0,0,c.width,c.height);
 draw(ctx,c);

 const img=ctx.getImageData(0,0,c.width,c.height).data;
 let i=0;
 const active=Math.floor(COUNT*0.65); // only 65% stars
 for(let y=0;y<c.height;y+=4){
  for(let x=0;x<c.width;x+=4){
   if(img[(y*c.width+x)*4]>10 && i<active){
    shape[i*3]=x-c.width/2;
    shape[i*3+1]=c.height/2-y;
    shape[i*3+2]=Math.random()*30-15;
    i++;
   }
  }
 }
 for(;i<COUNT;i++){
  shape[i*3]=galaxy[i*3];
  shape[i*3+1]=galaxy[i*3+1];
  shape[i*3+2]=galaxy[i*3+2];
 }
 targetBlend=1;
}

/* ================= TEXT / HEART ================= */
function textMorph(t){
 buildShape((ctx,c)=>{
  ctx.fillStyle="#fff";
  ctx.font=(innerHeight>innerWidth?26:34)+"px Playfair Display";
  ctx.textAlign="center";ctx.textBaseline="top";
  t.split("\n").forEach((l,i)=>ctx.fillText(l,c.width/2,40+i*44));
 });
}
function heartMorph(){
 buildShape((ctx,c)=>{
  ctx.fillStyle="#fff";
  ctx.translate(c.width/2,c.height/2);
  ctx.scale(1.4,1.4);
  ctx.beginPath();
  ctx.moveTo(0,40);
  ctx.bezierCurveTo(-90,-50,-50,-150,0,-60);
  ctx.bezierCurveTo(50,-150,90,-50,0,40);
  ctx.fill();
 });
}

/* ================= RESET ================= */
function resetGalaxy(){
 targetBlend=0;
 for(let i=0;i<COUNT;i++){
  galaxy[i*3]+=(Math.random()-0.5)*40;
  galaxy[i*3+1]+=(Math.random()-0.5)*40;
  galaxy[i*3+2]+=(Math.random()-0.5)*40;
 }
}

/* ================= RENDER LOOP ================= */
let t=0;
function animate(){
 requestAnimationFrame(animate);
 t+=0.002;

 blend+= (targetBlend-blend)*0.03;

 const p=geo.attributes.position.array;
 for(let i=0;i<COUNT;i++){
  const gx=galaxy[i*3];
  const gy=galaxy[i*3+1];
  const gz=galaxy[i*3+2];

  const sx=shape[i*3];
  const sy=shape[i*3+1];
  const sz=shape[i*3+2];

  p[i*3]   = gx + (sx-gx)*blend + Math.sin(t+i)*0.3;
  p[i*3+1] = gy + (sy-gy)*blend + Math.cos(t+i)*0.3;
  p[i*3+2] = gz + (sz-gz)*blend;
 }
 geo.attributes.position.needsUpdate=true;
 renderer.render(scene,camera);
}
animate();

/* ================= HAND ================= */
const video=document.getElementById("video");
const status=document.getElementById("gestureStatus");

const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({maxNumHands:1,selfieMode:true,minDetectionConfidence:.75});

let last=null,lastT=0;
function ext(t,p,m){return Math.atan2(t.y-p.y,t.x-p.x)<Math.atan2(p.y-m.y,p.x-m.x);}

hands.onResults(r=>{
 if(!r.multiHandLandmarks){resetGalaxy();status.textContent="Detecting…";last=null;return;}
 const lm=r.multiHandLandmarks[0];
 let f=0;
 if(ext(lm[8],lm[6],lm[5]))f++;
 if(ext(lm[12],lm[10],lm[9]))f++;
 if(ext(lm[16],lm[14],lm[13]))f++;
 if(ext(lm[20],lm[18],lm[17]))f++;
 const g=f===0?"fist":f;
 const now=Date.now();
 if(g!==last && now-lastT>900){
  last=g;lastT=now;
  if(g===1)textMorph(`Dear Laily Aliyah\n\nI want to sincerely apologize\nfor the situation that happened.`);
  if(g===2)textMorph(`I never intended to deceive you.\nI hope you can believe my sincerity.`);
  if(g===3)textMorph(`I’m really sorry for the misunderstanding.`);
  if(g===4)heartMorph();
  if(g===5)textMorph(`ilysm ly ♥`);
  if(g==="fist")textMorph(`from:\nRaja Iblis`);
 }
 status.textContent="Detected: "+g;
});

/* ================= START ================= */
document.getElementById("startBtn").onclick=async()=>{
 document.getElementById("startOverlay").style.display="none";
 const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:640,height:480}});
 video.srcObject=stream;await video.play();
 new Camera(video,{onFrame:()=>hands.send({image:video}),width:640,height:480}).start();
};
</script>
</body>
</html>
