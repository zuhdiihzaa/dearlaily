<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Dear Laily</title>

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#000;
  font-family: serif;
}
canvas{
  position:fixed;
  top:0;left:0;
}
#camBox{
  position:fixed;
  bottom:12px;
  right:12px;
  width:120px;
  height:160px;
  border:2px solid rgba(255,255,255,.4);
  border-radius:12px;
  overflow:hidden;
  backdrop-filter: blur(6px);
  z-index:10;
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
  transform: scaleX(-1);
}
#hint{
  position:fixed;
  top:10px;
  width:100%;
  text-align:center;
  color:#bbb;
  font-size:12px;
  z-index:10;
}
</style>
</head>
<body>

<div id="hint">Letakkan tangan di tengah kamera</div>
<div id="camBox"><video id="video" autoplay playsinline></video></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
// ================= SCENE =================
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(
  55,
  innerWidth/innerHeight,
  0.1,
  1000
);
camera.position.z = innerWidth < 768 ? 52 : 42;

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

// ================= PARTICLES =================
const COUNT = 2400;
const geo = new THREE.BufferGeometry();
const pos = [];
const colors = [];

const palette = [
  [1,1,1],
  [0.6,0.8,1],
  [0.8,0.6,1],
  [1,0.7,0.9]
];

for(let i=0;i<COUNT;i++){
  pos.push(
    (Math.random()-0.5)*120,
    (Math.random()-0.5)*120,
    (Math.random()-0.5)*120
  );
  const c = palette[Math.floor(Math.random()*palette.length)];
  colors.push(c[0],c[1],c[2]);
}

geo.setAttribute("position", new THREE.Float32BufferAttribute(pos,3));
geo.setAttribute("color", new THREE.Float32BufferAttribute(colors,3));

const mat = new THREE.PointsMaterial({
  size:0.7,
  vertexColors:true,
  transparent:true,
  opacity:0.9,
  depthWrite:false
});

const stars = new THREE.Points(geo, mat);
scene.add(stars);

// ================= TEXT GENERATOR =================
function makeText(text){
  const isMobile = innerWidth < 768;
  const c = document.createElement("canvas");
  c.width = isMobile ? 520 : 800;
  c.height = isMobile ? 520 : 400;

  const ctx = c.getContext("2d");
  ctx.fillStyle="white";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  const fontSize = isMobile ? 28 : 46;
  ctx.font = `${fontSize}px serif`;

  const words=text.split(" ");
  let line="", lines=[];
  const maxW=c.width*0.85;

  words.forEach(w=>{
    const t=line+w+" ";
    if(ctx.measureText(t).width>maxW){
      lines.push(line);
      line=w+" ";
    }else line=t;
  });
  lines.push(line);

  const lh=fontSize*1.4;
  const startY=c.height/2-(lines.length-1)*lh/2;
  lines.forEach((l,i)=>{
    ctx.fillText(l.trim(),c.width/2,startY+i*lh);
  });

  const data=ctx.getImageData(0,0,c.width,c.height).data;
  const arr=[];
  const scale=isMobile?0.18:0.22;

  for(let y=0;y<c.height;y+=3){
    for(let x=0;x<c.width;x+=3){
      if(data[(y*c.width+x)*4+3]>150){
        arr.push({
          x:(x-c.width/2)*scale,
          y:(c.height/2-y)*scale,
          z:0
        });
      }
    }
  }
  return arr;
}

// ================= TARGETS =================
const idleTargets = pos.map((_,i)=>({
  x:pos[i*3],y:pos[i*3+1],z:pos[i*3+2]
}));

let targets = idleTargets;

// ================= GESTURE LOCK =================
let lastGesture=null;
let currentGesture=null;
let gestureStart=0;
const HOLD=600;

function setIdle(){
  targets = idleTargets;
  currentGesture=null;
}

// ================= TRIGGER =================
function triggerGesture(g){
  if(g==="fist"){
    targets = makeText("from: Raja Iblis");
  }
  if(g===1){
    targets = makeText("Dear Laily Aliyah I want to sincerely apologize for the situation that happened");
  }
  if(g===2){
    targets = makeText("I never intended to deceive you or break your trust in any way");
  }
  if(g===3){
    targets = makeText("I’m really sorry for the misunderstanding");
  }
  if(g===4){
    targets = makeText("♥");
  }
  if(g===5){
    targets = makeText("ilysm ly ♥");
  }
}

// ================= MEDIAPIPE =================
const video=document.getElementById("video");

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

hands.onResults(res=>{
  if(!res.multiHandLandmarks){
    lastGesture=null;
    gestureStart=0;
    setIdle();
    return;
  }

  const lm=res.multiHandLandmarks[0];
  const tips=[8,12,16,20];
  let count=0;
  tips.forEach(i=>{
    if(lm[i].y < lm[i-2].y) count++;
  });

  let g = count===0 ? "fist" : count;
  const now=Date.now();

  if(g!==lastGesture){
    lastGesture=g;
    gestureStart=now;
    return;
  }

  if(currentGesture!==g && now-gestureStart>HOLD){
    currentGesture=g;
    triggerGesture(g);
  }
});

const cam=new Camera(video,{
  onFrame:async()=>{ await hands.send({image:video}); },
  width:360,
  height:480
});
cam.start();

// ================= ANIMATION =================
function animate(){
  requestAnimationFrame(animate);
  const p=geo.attributes.position.array;

  for(let i=0;i<COUNT;i++){
    const t=targets[i%targets.length];
    p[i*3]+= (t.x-p[i*3]) * 0.08;
    p[i*3+1]+= (t.y-p[i*3+1]) * 0.08;
    p[i*3+2]+= (t.z-p[i*3+2]) * 0.08;
  }
  geo.attributes.position.needsUpdate=true;
  stars.rotation.y+=0.0006;
  renderer.render(scene,camera);
}
animate();

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
