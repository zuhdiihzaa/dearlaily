<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cosmic Gesture Message</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<!-- THREE -->
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/FontLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/geometries/TextGeometry.js"></script>

<!-- MEDIAPIPE -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:black;
  touch-action:manipulation;
}

#camBox{
  position:fixed;
  right:12px;
  bottom:12px;
  width:220px;
  height:160px;
  border-radius:12px;
  overflow:hidden;
  border:1.5px solid rgba(255,255,255,.6);
  z-index:10;
}

#camBox video{
  width:100%;
  height:100%;
  object-fit:cover;
}

#hint{
  position:absolute;
  width:100%;
  top:0;
  text-align:center;
  font-size:13px;
  color:white;
  background:rgba(0,0,0,.5);
}
</style>
</head>

<body>

<div id="camBox">
  <div id="hint">Letakkan tangan di tengah</div>
  <video id="video" playsinline autoplay muted></video>
</div>

<audio id="music" loop preload="auto">
  <source src="https://cdn.pixabay.com/audio/2022/10/25/audio_1d82c0c5ab.mp3">
</audio>

<script>
/* ===============================
   THREE JS – SAFE SETUP
================================ */
const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x000011, 400, 2200);

const camera = new THREE.PerspectiveCamera(
  60, innerWidth/innerHeight, 1, 5000
);
camera.position.z = 700;

const renderer = new THREE.WebGLRenderer({
  antialias:true,
  powerPreference:"high-performance"
});
renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

/* LIGHT */
scene.add(new THREE.AmbientLight(0xffccff,0.6));
const dir = new THREE.DirectionalLight(0xffffff,0.8);
dir.position.set(5,10,7);
scene.add(dir);

/* STARS (LIMITED FOR MOBILE) */
const STAR_COUNT = 6000;
const starGeo = new THREE.BufferGeometry();
const starPos = new Float32Array(STAR_COUNT*3);
for(let i=0;i<starPos.length;i++){
  starPos[i]=(Math.random()-0.5)*3000;
}
starGeo.setAttribute('position', new THREE.BufferAttribute(starPos,3));
const starMat = new THREE.PointsMaterial({color:0xffffff,size:1.8});
const stars = new THREE.Points(starGeo, starMat);
scene.add(stars);

/* TEXT */
let textMesh=null, font=null;
new THREE.FontLoader().load(
  'https://threejs.org/examples/fonts/helvetiker_regular.typeface.json',
  f=>font=f
);

function clearSceneObject(obj){
  if(obj){
    scene.remove(obj);
    obj.geometry.dispose();
  }
}

function showText(msg){
  if(!font) return;
  clearSceneObject(textMesh);

  const geo = new THREE.TextGeometry(msg,{
    font,size:26,height:6,curveSegments:6
  });
  geo.center();

  const mat = new THREE.MeshStandardMaterial({
    color:0xffb6ff,
    emissive:0x331133,
    roughness:0.25
  });

  textMesh=new THREE.Mesh(geo,mat);
  scene.add(textMesh);
}

/* HEART */
let heart=null;
function showHeart(){
  clearSceneObject(heart);

  const s=new THREE.Shape();
  s.moveTo(0,30);
  s.bezierCurveTo(0,30,-30,0,-60,0);
  s.bezierCurveTo(-90,0,-90,45,-90,45);
  s.bezierCurveTo(-90,75,-45,105,0,120);
  s.bezierCurveTo(45,105,90,75,90,45);
  s.bezierCurveTo(90,45,90,0,60,0);
  s.bezierCurveTo(30,0,0,30,0,30);

  const geo=new THREE.ExtrudeGeometry(s,{
    depth:20,bevelEnabled:true,
    bevelSize:5,bevelThickness:5
  });

  const mat=new THREE.MeshStandardMaterial({
    color:0xff3366,
    emissive:0x440011,
    roughness:0.15
  });

  heart=new THREE.Mesh(geo,mat);
  heart.scale.set(2,2,2);
  scene.add(heart);
}

/* RENDER LOOP */
function animate(){
  requestAnimationFrame(animate);
  stars.rotation.y+=0.00025;
  if(heart) heart.rotation.y+=0.01;
  renderer.render(scene,camera);
}
animate();

/* ===============================
   MEDIAPIPE – STABLE MODE
================================ */
const video=document.getElementById('video');
const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands:1,
  minDetectionConfidence:0.75,
  minTrackingConfidence:0.75
});

let lastGesture="";
let lock=false;

function trigger(name,cb){
  if(lock||lastGesture===name) return;
  lock=true;
  lastGesture=name;
  cb();
  setTimeout(()=>lock=false,1200);
}

hands.onResults(r=>{
  if(!r.multiHandLandmarks) return;
  const lm=r.multiHandLandmarks[0];

  const open=[
    lm[8].y<lm[6].y,
    lm[12].y<lm[10].y,
    lm[16].y<lm[14].y,
    lm[20].y<lm[18].y
  ];
  const thumb=lm[4].x<lm[3].x;
  const c=open.filter(v=>v).length+(thumb?1:0);

  if(c===0) trigger("rock",()=>showText("from: Raja Iblis"));
  if(c===2) trigger("peace",()=>showText("I never intended to deceive you."));
  if(c===3) trigger("three",()=>showText("I’m really sorry for the misunderstanding."));
  if(c===4) trigger("four",showHeart);
  if(c===5) trigger("five",()=>showText("ilysm ly ♥"));
});

/* CAMERA */
new Camera(video,{
  onFrame:async()=>hands.send({image:video}),
  width:640,height:480
}).start();

/* AUDIO – iOS SAFE */
document.body.addEventListener("click",()=>{
  const m=document.getElementById("music");
  if(m.paused) m.play();
},{once:true});
</script>

</body>
</html>
