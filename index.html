<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cosmic Message</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:wght@500&display=swap" rel="stylesheet">

<style>
html,body{
  margin:0;
  padding:0;
  background:black;
  overflow:hidden;
  font-family:'Playfair Display',serif;
  touch-action:none;
}

canvas{
  position:fixed;
  inset:0;
}

#startScreen{
  position:fixed;
  inset:0;
  background:radial-gradient(circle at center,#12002b,#000);
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  z-index:20;
  font-size:18px;
  letter-spacing:2px;
}

#cameraBox{
  position:fixed;
  bottom:14px;
  right:14px;
  width:150px;
  height:200px;
  border-radius:16px;
  overflow:hidden;
  border:2px solid rgba(255,255,255,0.5);
  backdrop-filter:blur(8px);
  z-index:10;
}

#cameraBox::before{
  content:"+";
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-size:28px;
  opacity:0.7;
  pointer-events:none;
}

#cameraBox::after{
  content:"Arahkan tangan di tengah";
  position:absolute;
  bottom:4px;
  width:100%;
  text-align:center;
  font-size:10px;
  color:white;
  opacity:0.8;
}

video{
  width:100%;
  height:100%;
  object-fit:cover;
  transform:scaleX(-1);
}

audio{display:none}
</style>
</head>

<body>

<div id="startScreen">TOUCH ANYWHERE TO BEGIN</div>

<div id="cameraBox" style="display:none">
  <video id="video" autoplay muted playsinline></video>
</div>

<audio id="music" loop>
  <source src="https://cdn.pixabay.com/audio/2022/10/26/audio_89c7b5d0f4.mp3" type="audio/mpeg">
</audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* =========================
   THREE SCENE
========================= */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,1,5000);
camera.position.z=900;

const renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

/* Galaxy */
const starGeo=new THREE.BufferGeometry();
const starCount=4500;
const pos=[];
for(let i=0;i<starCount;i++){
  const r=Math.random()*1500;
  const a=Math.random()*Math.PI*2;
  pos.push(
    Math.cos(a)*r,
    (Math.random()-0.5)*800,
    Math.sin(a)*r
  );
}
starGeo.setAttribute("position",new THREE.Float32BufferAttribute(pos,3));

const starMat=new THREE.PointsMaterial({
  color:0xffffff,
  size:2,
  transparent:true,
  opacity:0.8
});
const stars=new THREE.Points(starGeo,starMat);
scene.add(stars);

/* Lights */
scene.add(new THREE.AmbientLight(0x6644ff,0.8));
const glow=new THREE.PointLight(0xaa88ff,1.5,3000);
glow.position.set(0,0,600);
scene.add(glow);

/* =========================
   TEXT PARTICLE
========================= */
let textPoints=null;
function morphText(msg){
  if(textPoints) scene.remove(textPoints);

  const c=document.createElement("canvas");
  c.width=2000;
  c.height=500;
  const x=c.getContext("2d");
  x.fillStyle="white";
  x.textAlign="center";
  x.font="80px Great Vibes";
  x.fillText(msg,c.width/2,c.height/2);

  const data=x.getImageData(0,0,c.width,c.height).data;
  const g=new THREE.BufferGeometry();
  const p=[];
  for(let y=0;y<c.height;y+=4){
    for(let x2=0;x2<c.width;x2+=4){
      const i=(y*c.width+x2)*4;
      if(data[i+3]>150){
        p.push(
          (x2-c.width/2)*0.8,
          (c.height/2-y)*0.8,
          0
        );
      }
    }
  }
  g.setAttribute("position",new THREE.Float32BufferAttribute(p,3));
  textPoints=new THREE.Points(g,new THREE.PointsMaterial({
    color:0xffffff,
    size:2.2,
    transparent:true,
    opacity:1
  }));
  scene.add(textPoints);
}

/* =========================
   GESTURE
========================= */
let last=-1,hold=0;
function gesture(n){
  if(n!==last){hold=0;last=n;return;}
  hold++;
  if(hold<20)return;

  const map={
    1:"Dear Laily Aliyah,\nI want to sincerely apologize...",
    2:"I never intended to deceive you or break your trust...",
    3:"I’m really sorry for the misunderstanding...",
    4:"♥",
    5:"ilysm ly ♥",
    0:"from: Raja Iblis"
  };
  morphText(map[n]);
}

/* =========================
   MEDIAPIPE
========================= */
const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

hands.onResults(r=>{
  if(!r.multiHandLandmarks.length){
    if(textPoints){
      textPoints.material.opacity*=0.95;
      if(textPoints.material.opacity<0.02){
        scene.remove(textPoints);
        textPoints=null;
      }
    }
    last=-1;
    return;
  }
  const lm=r.multiHandLandmarks[0];
  const tips=[4,8,12,16,20];
  let c=0;
  for(let i=1;i<5;i++) if(lm[tips[i]].y<lm[tips[i]-2].y)c++;
  if(lm[4].x<lm[3].x)c++;
  gesture(c);
});

/* =========================
   START
========================= */
const video=document.getElementById("video");
const cam=new Camera(video,{
  onFrame:async()=>hands.send({image:video}),
  width:640,height:480
});

document.getElementById("startScreen").onclick=()=>{
  document.getElementById("startScreen").remove();
  document.getElementById("cameraBox").style.display="block";
  document.getElementById("music").play();
  cam.start();
};

/* =========================
   LOOP
========================= */
function animate(){
  requestAnimationFrame(animate);
  stars.rotation.y+=0.0006;
  stars.rotation.x+=0.0003;
  camera.position.x=Math.sin(Date.now()*0.0001)*30;
  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
