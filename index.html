<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cosmic Gesture Message</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display&display=swap" rel="stylesheet">

<style>
html,body{
 margin:0;
 padding:0;
 background:#000;
 overflow:hidden;
 font-family:'Playfair Display',serif;
}
#container{position:fixed;inset:0}
#gestureStatus{
 position:fixed;
 top:10px;
 left:50%;
 transform:translateX(-50%);
 color:#fff;
 font-size:13px;
 opacity:.85;
 z-index:5;
}
#cameraBox{
 position:fixed;
 bottom:12px;
 right:12px;
 width:120px;
 height:160px;
 border-radius:16px;
 overflow:hidden;
 border:2px solid rgba(255,255,255,.4);
 box-shadow:0 0 20px rgba(255,255,255,.3);
 z-index:5;
}
#cameraBox video{
 width:100%;
 height:100%;
 object-fit:cover;
 transform:scaleX(-1);
}
#startOverlay{
 position:fixed;
 inset:0;
 z-index:10;
 display:flex;
 align-items:center;
 justify-content:center;
 background:radial-gradient(circle,#2a0044,#000);
 color:#fff;
 text-align:center;
}
#startOverlay button{
 padding:16px 30px;
 border-radius:40px;
 border:none;
 background:#fff;
 font-size:18px;
 cursor:pointer;
}
</style>
</head>
<body>

<div id="container"></div>
<div id="gestureStatus">Detecting…</div>

<div id="cameraBox">
 <video id="video" playsinline></video>
</div>

<div id="startOverlay">
 <div>
  <h2>✨ Tap to Start ✨</h2>
  <p>Allow camera access</p>
  <button id="startBtn">Start Experience</button>
 </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>

<script>
/* ================= THREE SETUP ================= */
const scene=new THREE.Scene();
scene.fog=new THREE.FogExp2(0x060014,0.0012);

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,1,3000);
camera.position.z=500;

const renderer=new THREE.WebGLRenderer({antialias:false});
renderer.setPixelRatio(Math.min(devicePixelRatio,1.5));
renderer.setSize(innerWidth,innerHeight);
document.getElementById("container").appendChild(renderer.domElement);

/* ================= STARS ================= */
const COUNT=innerWidth<768?1400:3200;
const geo=new THREE.BufferGeometry();
const pos=new Float32Array(COUNT*3);
const galaxy=new Float32Array(COUNT*3);
const shape=new Float32Array(COUNT*3);

for(let i=0;i<COUNT;i++){
 galaxy[i*3]=(Math.random()-0.5)*1800;
 galaxy[i*3+1]=(Math.random()-0.5)*1800;
 galaxy[i*3+2]=(Math.random()-0.5)*1800;
 pos.set(galaxy);
 shape.set(galaxy);
}
geo.setAttribute("position",new THREE.BufferAttribute(pos,3));

const stars=new THREE.Points(
 geo,
 new THREE.PointsMaterial({
  color:0xffffff,
  size:innerWidth<768?2.4:1.8,
  transparent:true,
  opacity:0.95,
  blending:THREE.AdditiveBlending
 })
);
scene.add(stars);

/* ================= NEBULA ================= */
const nebula=new THREE.Points(
 geo.clone(),
 new THREE.PointsMaterial({
  color:0x5522ff,
  size:3,
  opacity:0.05,
  transparent:true,
  blending:THREE.AdditiveBlending
 })
);
scene.add(nebula);

/* ================= GALAXY MOTION ================= */
const orbitRadius=new Float32Array(COUNT);
const orbitSpeed=new Float32Array(COUNT);
const orbitAngle=new Float32Array(COUNT);
const driftZ=new Float32Array(COUNT);

for(let i=0;i<COUNT;i++){
 orbitRadius[i]=Math.random()*500+200;
 orbitSpeed[i]=Math.random()*0.0006+0.0002;
 orbitAngle[i]=Math.random()*Math.PI*2;
 driftZ[i]=Math.random()*Math.PI*2;
}

/* ================= BLEND ================= */
let blend=0,targetBlend=0;

/* ================= COLORS ================= */
const messageColors={
 1:0xffa7c4,
 2:0xa7d8ff,
 3:0xffd27d,
 4:0xff4b6e,
 5:0xbaffc9,
 fist:0xffffff
};

/* ================= SHAPE BUILDER ================= */
function buildShape(draw){
 const c=document.createElement("canvas");
 const ctx=c.getContext("2d");

 c.width=innerHeight>innerWidth?380:900;
 c.height=innerHeight>innerWidth?560:420;

 ctx.fillStyle="#000";
 ctx.fillRect(0,0,c.width,c.height);

 ctx.shadowColor="#fff";
 ctx.shadowBlur=20;

 draw(ctx,c);

 const img=ctx.getImageData(0,0,c.width,c.height).data;
 let i=0;
 const active=Math.floor(COUNT*0.65);

 for(let y=0;y<c.height;y+=4){
  for(let x=0;x<c.width;x+=4){
   if(img[(y*c.width+x)*4]>10 && i<active){
    shape[i*3]=x-c.width/2;
    shape[i*3+1]=c.height/2-y;
    shape[i*3+2]=(Math.random()-0.5)*40;
    i++;
   }
  }
 }
 for(;i<COUNT;i++){
  shape[i*3]=galaxy[i*3];
  shape[i*3+1]=galaxy[i*3+1];
  shape[i*3+2]=galaxy[i*3+2];
 }
 targetBlend=1;
}

/* ================= TEXT ================= */
function textMorph(t){
 buildShape((ctx,c)=>{
  ctx.fillStyle="#fff";
  ctx.textAlign="center";
  ctx.textBaseline="top";
  ctx.font=(innerHeight>innerWidth?26:34)+"px Playfair Display";
  t.split("\n").forEach((l,i)=>{
   ctx.fillText(l,c.width/2,40+i*44);
  });
 });
}

/* ================= HEART ================= */
function heartMorph(){
 buildShape((ctx,c)=>{
  ctx.fillStyle="#fff";
  ctx.translate(c.width/2,c.height/2);
  ctx.scale(1.3,1.3);
  ctx.beginPath();
  ctx.moveTo(0,60);
  ctx.bezierCurveTo(-120,-40,-60,-180,0,-80);
  ctx.bezierCurveTo(60,-180,120,-40,0,60);
  ctx.fill();
 });
 for(let i=0;i<COUNT;i++){
  shape[i*3+2]+=Math.sin(i)*30;
 }
}

/* ================= RESET ================= */
function resetGalaxy(){targetBlend=0}

/* ================= CAMERA ================= */
let camPhase=Math.random()*Math.PI*2;
function cinematicCamera(t){
 camPhase+=0.0006;
 camera.position.x=Math.sin(camPhase)*80;
 camera.position.y=Math.cos(camPhase*0.8)*60;
 camera.position.z=500+Math.sin(camPhase*0.5)*40;
 camera.lookAt(0,0,0);
}

/* ================= RENDER ================= */
let t=0;
function animate(){
 requestAnimationFrame(animate);
 t+=0.003;

 blend+=(targetBlend-blend)*0.025;
 if(Math.abs(targetBlend-blend)<0.01)blend=targetBlend;

 const p=geo.attributes.position.array;
 for(let i=0;i<COUNT;i++){
  orbitAngle[i]+=orbitSpeed[i];
  const gx=galaxy[i*3]+Math.cos(orbitAngle[i])*orbitRadius[i];
  const gy=galaxy[i*3+1]+Math.sin(orbitAngle[i])*orbitRadius[i];
  const gz=galaxy[i*3+2]+Math.sin(t+driftZ[i])*25;

  p[i*3]=gx+(shape[i*3]-gx)*blend;
  p[i*3+1]=gy+(shape[i*3+1]-gy)*blend;
  p[i*3+2]=gz+(shape[i*3+2]-gz)*blend;
 }
 geo.attributes.position.needsUpdate=true;

 nebula.rotation.z+=0.0004;
 nebula.rotation.y+=0.0002;

 cinematicCamera(t);
 renderer.render(scene,camera);
}
animate();

/* ================= MEDIAPIPE HANDS ================= */
const video=document.getElementById("video");
const status=document.getElementById("gestureStatus");

const hands=new Hands({
 locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
 maxNumHands:1,
 selfieMode:true,
 modelComplexity:0,
 minDetectionConfidence:0.7,
 minTrackingConfidence:0.7
});

function fingerExtended(tip,pip,mcp){
 const d1=Math.hypot(tip.x-pip.x,tip.y-pip.y);
 const d2=Math.hypot(pip.x-mcp.x,pip.y-mcp.y);
 return d1>d2*0.85;
}

let last=null,lastT=0;

hands.onResults(r=>{
 if(!r.multiHandLandmarks){
  resetGalaxy();
  status.textContent="Detecting…";
  return;
 }

 const lm=r.multiHandLandmarks[0];
 let f=0;
 if(fingerExtended(lm[8],lm[6],lm[5]))f++;
 if(fingerExtended(lm[12],lm[10],lm[9]))f++;
 if(fingerExtended(lm[16],lm[14],lm[13]))f++;
 if(fingerExtended(lm[20],lm[18],lm[17]))f++;

 const g=f===0?"fist":f;
 const now=Date.now();

 if(g!==last && now-lastT>800){
  last=g;lastT=now;
  stars.material.color.setHex(messageColors[g]||0xffffff);

  if(g===1)textMorph(`Dear Laily Aliyah,\n\nI want to sincerely apologize\nfor the situation that happened.`);
  if(g===2)textMorph(`I never intended to deceive you.\nI hope you can believe my sincerity.`);
  if(g===3)textMorph(`I’m really sorry for the misunderstanding.`);
  if(g===4)heartMorph();
  if(g===5)textMorph(`ilysm ly ♥`);
  if(g==="fist")textMorph(`from:\nRaja Iblis`);

  camera.position.z-=40;
  setTimeout(()=>camera.position.z+=40,600);
 }
 status.textContent="Detected: "+g;
});

/* ================= START ================= */
document.getElementById("startBtn").onclick=async()=>{
 document.getElementById("startOverlay").style.display="none";

 const stream=await navigator.mediaDevices.getUserMedia({
  video:{facingMode:"user",width:640,height:480}
 });
 video.srcObject=stream;
 await video.play();

 async function processFrame(){
  if(video.readyState>=2){
   await hands.send({image:video});
  }
  requestAnimationFrame(processFrame);
 }
 processFrame();
};
</script>
</body>
</html>
