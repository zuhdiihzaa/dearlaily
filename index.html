<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Dear Laily</title>

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#000;
}
canvas{
  position:fixed;
  top:0;left:0;
}
#camBox{
  position:fixed;
  bottom:12px;
  right:12px;
  width:120px;
  height:160px;
  border:2px solid rgba(255,255,255,.4);
  border-radius:12px;
  overflow:hidden;
  z-index:10;
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
  transform: scaleX(-1);
}
#hint{
  position:fixed;
  top:10px;
  width:100%;
  text-align:center;
  color:#aaa;
  font-size:12px;
  z-index:10;
}
</style>
</head>
<body>

<div id="hint">Arahkan tangan ke tengah kamera</div>
<div id="camBox"><video id="video" autoplay playsinline></video></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
// ================= THREE =================
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(55,innerWidth/innerHeight,0.1,1000);
camera.position.z = innerWidth < 768 ? 52 : 42;

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

// ================= STARS =================
const COUNT = 2400;
const geo = new THREE.BufferGeometry();
const pos = [];

for(let i=0;i<COUNT;i++){
  pos.push(
    (Math.random()-0.5)*120,
    (Math.random()-0.5)*120,
    (Math.random()-0.5)*120
  );
}
geo.setAttribute("position",new THREE.Float32BufferAttribute(pos,3));

const mat = new THREE.PointsMaterial({
  size:0.6,
  color:0xffffff,
  transparent:true,
  opacity:0.9
});
const stars = new THREE.Points(geo,mat);
scene.add(stars);

// ================= TEXT =================
function makeText(text){
  const c=document.createElement("canvas");
  c.width=700;
  c.height=350;
  const ctx=c.getContext("2d");
  ctx.fillStyle="white";
  ctx.font="40px serif";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  ctx.fillText(text,c.width/2,c.height/2);

  const d=ctx.getImageData(0,0,c.width,c.height).data;
  const arr=[];
  for(let y=0;y<c.height;y+=3){
    for(let x=0;x<c.width;x+=3){
      if(d[(y*c.width+x)*4+3]>150){
        arr.push({
          x:(x-c.width/2)*0.25,
          y:(c.height/2-y)*0.25,
          z:0
        });
      }
    }
  }
  return arr;
}

// ================= TARGETS =================
const idleTargets = pos.map((_,i)=>({
  x:pos[i*3], y:pos[i*3+1], z:pos[i*3+2]
}));
let targets = idleTargets;

// ================= TRIGGER =================
function triggerGesture(g){
  if(g==="fist"){
    targets = makeText("from: Raja Iblis");
  }
  if(g===1){
    targets = makeText("Dear Laily Aliyah");
  }
  if(g===2){
    targets = makeText("I respect your feelings");
  }
  if(g===3){
    targets = makeText("I’m really sorry");
  }
  if(g===4){
    targets = makeText("♥");
  }
  if(g===5){
    targets = makeText("ilysm ly ♥");
  }
}

// ================= MEDIAPIPE =================
const video=document.getElementById("video");

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

hands.onResults(res=>{
  if(!res.multiHandLandmarks){
    targets = idleTargets;
    return;
  }

  const lm=res.multiHandLandmarks[0];
  const tips=[8,12,16,20];
  let count=0;
  tips.forEach(i=>{
    if(lm[i].y < lm[i-2].y) count++;
  });

  let g = count===0 ? "fist" : count;
  triggerGesture(g);
});

const cam=new Camera(video,{
  onFrame:async()=>{ await hands.send({image:video}); },
  width:360,
  height:480
});
cam.start();

// ================= ANIMATE =================
function animate(){
  requestAnimationFrame(animate);
  const p=geo.attributes.position.array;
  for(let i=0;i<COUNT;i++){
    const t=targets[i%targets.length];
    p[i*3]+= (t.x-p[i*3]) * 0.08;
    p[i*3+1]+= (t.y-p[i*3+1]) * 0.08;
    p[i*3+2]+= (t.z-p[i*3+2]) * 0.08;
  }
  geo.attributes.position.needsUpdate=true;
  stars.rotation.y+=0.0006;
  renderer.render(scene,camera);
}
animate();

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
