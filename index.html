<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dear Laily — Cinematic Galaxy Gesture</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Great+Vibes&display=swap" rel="stylesheet">

<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  overflow:hidden;
  background:#000;
  font-family:'Playfair Display',serif;
}
canvas{display:block}

#overlay{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
  cursor:pointer;
}
#overlay h1{
  color:#fff;
  font-size:2rem;
  opacity:.8;
  animation:pulse 2s infinite;
}
@keyframes pulse{
  0%,100%{opacity:.4}
  50%{opacity:1}
}

#status{
  position:fixed;
  top:12px;
  left:12px;
  color:#9cf;
  font-size:12px;
  z-index:5;
  opacity:.8;
}

#gestureInfo{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  color:#fff;
  font-size:14px;
  opacity:0;
  transition:opacity .5s;
  z-index:5;
}

#camBox{
  position:fixed;
  right:10px;
  bottom:10px;
  width:160px;
  aspect-ratio:4/3;
  border:1px solid rgba(255,255,255,.3);
  border-radius:8px;
  overflow:hidden;
  display:none;
  z-index:5;
}
#camBox video{
  width:100%;
  height:100%;
  object-fit:cover;
  transform:scaleX(-1);
}
#camOverlay{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size:11px;
  text-align:center;
  pointer-events:none;
  background:rgba(0,0,0,.25);
}
</style>
</head>

<body>
<div id="overlay"><h1>Tap anywhere to start</h1></div>
<div id="status">CAMERA: OFF</div>
<div id="gestureInfo"></div>

<div id="camBox">
  <video id="video" playsinline muted></video>
  <div id="camOverlay">Place your hand<br/>in the center</div>
</div>

<audio id="music" loop>
  <source src="https://cdn.pixabay.com/download/audio/2022/08/02/audio_8b77f6b86b.mp3?filename=deep-space-ambient-110624.mp3">
</audio>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ================== THREE SETUP ================== */
const scene=new THREE.Scene()
scene.fog=new THREE.FogExp2(0x000010,0.0006)

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,1,2000)
camera.position.z=500

const renderer=new THREE.WebGLRenderer({antialias:true})
renderer.setSize(innerWidth,innerHeight)
renderer.setPixelRatio(devicePixelRatio)
document.body.appendChild(renderer.domElement)

window.addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight
  camera.updateProjectionMatrix()
  renderer.setSize(innerWidth,innerHeight)
})

/* ================== PARTICLES ================== */
const COUNT=8000
const positions=new Float32Array(COUNT*3)
const galaxy=new Float32Array(COUNT*3)
const target=new Float32Array(COUNT*3)

for(let i=0;i<COUNT;i++){
  const r=Math.random()*800
  const a=Math.random()*Math.PI*2
  const y=(Math.random()-.5)*200
  galaxy[i*3]=Math.cos(a)*r
  galaxy[i*3+1]=y
  galaxy[i*3+2]=Math.sin(a)*r
  positions.set(galaxy,i*3)
  target.set(galaxy,i*3)
}

const geo=new THREE.BufferGeometry()
geo.setAttribute('position',new THREE.BufferAttribute(positions,3))

const mat=new THREE.PointsMaterial({
  color:0xffffff,
  size:2,
  transparent:true,
  opacity:.85,
  depthWrite:false,
  blending:THREE.AdditiveBlending
})

const points=new THREE.Points(geo,mat)
scene.add(points)

/* ================== ANIMATION BASE ================== */
let t=0
function animate(){
  requestAnimationFrame(animate)
  t+=0.002

  const p=geo.attributes.position.array
  for(let i=0;i<COUNT;i++){
    const ix=i*3
    p[ix]+= (target[ix]-p[ix])*0.04
    p[ix+1]+= (target[ix+1]-p[ix+1])*0.04
    p[ix+2]+= (target[ix+2]-p[ix+2])*0.04

    const tw=1+Math.sin(t+i)*0.002
    p[ix]*=tw; p[ix+1]*=tw; p[ix+2]*=tw
  }
  geo.attributes.position.needsUpdate=true

  points.rotation.y+=0.0006
  points.rotation.x+=0.0002

  renderer.render(scene,camera)
}
animate()

/* ================== TEXT & SHAPES ================== */
function toGalaxy(){
  target.set(galaxy)
}

function toHeart(){
  for(let i=0;i<COUNT;i++){
    const a=Math.random()*Math.PI*2
    const r=10*Math.sqrt(Math.random())
    const x=r*Math.sin(a)
    const z=r*Math.cos(a)
    const y=Math.abs(x)*0.8
    target[i*3]=x*12
    target[i*3+1]=y*12
    target[i*3+2]=z*12
  }
}

function toText(str){
  const canvas=document.createElement('canvas')
  canvas.width=1200
  canvas.height=300
  const ctx=canvas.getContext('2d')
  ctx.fillStyle="#000"
  ctx.fillRect(0,0,canvas.width,canvas.height)
  ctx.font="48px Playfair Display"
  ctx.fillStyle="#fff"
  ctx.textAlign="center"
  ctx.textBaseline="middle"
  wrapText(ctx,str,canvas.width/2,canvas.height/2,1100,56)

  const img=ctx.getImageData(0,0,canvas.width,canvas.height).data
  let ptr=0
  for(let y=0;y<canvas.height;y+=2){
    for(let x=0;x<canvas.width;x+=2){
      const id=(y*canvas.width+x)*4
      if(img[id]>200 && ptr<COUNT){
        target[ptr*3]=(x-canvas.width/2)
        target[ptr*3+1]=(canvas.height/2-y)
        target[ptr*3+2]=(Math.random()-.5)*50
        ptr++
      }
    }
  }
  for(;ptr<COUNT;ptr++){
    target[ptr*3]=galaxy[ptr*3]
    target[ptr*3+1]=galaxy[ptr*3+1]
    target[ptr*3+2]=galaxy[ptr*3+2]
  }
}

function wrapText(ctx,text,x,y,maxWidth,lineHeight){
  const words=text.split(" ")
  let line="",yy=y
  for(let n=0;n<words.length;n++){
    const test=line+words[n]+" "
    if(ctx.measureText(test).width>maxWidth){
      ctx.fillText(line,x,yy)
      line=words[n]+" "
      yy+=lineHeight
    }else line=test
  }
  ctx.fillText(line,x,yy)
}

/* ================== GESTURE SYSTEM ================== */
const STATE={IDLE:0,DISPLAY:1}
let state=STATE.IDLE
let buffer=[]
let lastStable=null
let lastTime=0

function pushGesture(g){
  const now=performance.now()
  buffer.push({g,now})
  buffer=buffer.filter(v=>now-v.now<350)

  const map={}
  buffer.forEach(v=>map[v.g]=(map[v.g]||0)+1)
  let best=null,max=0
  for(const k in map){
    if(map[k]>max){max=map[k];best=k}
  }
  if(best!==lastStable && max>=8){
    lastStable=best
    lastTime=now
    return best
  }
  return null
}

const gestureInfo=document.getElementById('gestureInfo')
function showGesture(t){
  gestureInfo.textContent="Gesture detected: "+t
  gestureInfo.style.opacity=1
  clearTimeout(showGesture._t)
  showGesture._t=setTimeout(()=>gestureInfo.style.opacity=0,1500)
}

function applyGesture(g){
  state=STATE.DISPLAY
  showGesture(g)
  if(g==="1")toText(`Dear Laily Aliyah,

I want to sincerely apologize for the situation that happened. I’m truly sorry if everything made you feel disappointed, confused, or hurt. What hurts me the most is knowing that you thought I was lying, even though I was being honest from the beginning.`)
  else if(g==="2")toText(`I never intended to deceive you or break your trust in any way. I understand why you might have felt that way, and I respect your feelings. Still, I hope one day you can believe that my words were genuine and came from a sincere place.`)
  else if(g==="3")toText(`I’m really sorry for the misunderstanding, and I truly hope we can clear things up and move forward with honesty and respect.`)
  else if(g==="4")toHeart()
  else if(g==="5")toText("ilysm ly ♥")
  else if(g==="fist")toText("from: Raja Iblis")
}

/* ================== CAMERA ================== */
const overlay=document.getElementById('overlay')
const statusEl=document.getElementById('status')
const video=document.getElementById('video')
const camBox=document.getElementById('camBox')
const music=document.getElementById('music')

let hands,cam,stream
let started=false

overlay.addEventListener('pointerdown',async()=>{
  if(started)return
  started=true
  overlay.style.display='none'
  try{await music.play();music.volume=.35}catch(e){}
  requestCamera()
},{once:true})

async function requestCamera(){
  statusEl.textContent="CAMERA: REQUESTING"
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:false})
    video.srcObject=stream
    await video.play()
    statusEl.textContent="CAMERA: LIVE"
    camBox.style.display='block'
    startHands()
  }catch(e){
    statusEl.textContent="CAMERA: DENIED"
    setTimeout(requestCamera,3000)
  }
}

function startHands(){
  hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`})
  hands.setOptions({maxNumHands:1,minDetectionConfidence:.6,minTrackingConfidence:.6})
  hands.onResults(res=>{
    if(!res.multiHandLandmarks){
      if(state===STATE.DISPLAY){toGalaxy();state=STATE.IDLE}
      return
    }
    const lm=res.multiHandLandmarks[0]
    const tips=[8,12,16,20]
    let c=0
    tips.forEach(i=>{if(lm[i].y<lm[i-2].y)c++})
    const g=c===0?"fist":String(c)
    const v=pushGesture(g)
    if(v)applyGesture(v)
  })
  cam=new Camera(video,{onFrame:async()=>{await hands.send({image:video})}})
  cam.start()
}
</script>
</body>
</html>
