<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Dear Laily â€“ Phase Stable</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:black;
  overflow:hidden;
  font-family:serif;
}
#status{
  position:fixed;
  bottom:12px;
  left:12px;
  color:#8ab4ff;
  font-size:13px;
  z-index:10;
}
#camBox{
  position:fixed;
  top:12px;
  right:12px;
  width:150px;
  aspect-ratio:1/1;
  border-radius:14px;
  overflow:hidden;
  border:2px dashed rgba(255,255,255,.4);
  z-index:5;
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
  transform:scaleX(1); /* NOT MIRROR */
}
</style>
</head>

<body>
<div id="camBox">
  <video id="video" autoplay playsinline></video>
</div>
<div id="status">idle</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<script>
/* =====================
   THREE SCENE
===================== */
const scene = new THREE.Scene();
const cam = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
cam.position.z = 60;

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
document.body.appendChild(renderer.domElement);

/* =====================
   ROUND STAR TEXTURE
===================== */
const starC = document.createElement("canvas");
starC.width = starC.height = 64;
const s = starC.getContext("2d");
const g = s.createRadialGradient(32,32,2,32,32,32);
g.addColorStop(0,"white");
g.addColorStop(1,"transparent");
s.fillStyle=g;
s.beginPath();
s.arc(32,32,32,0,Math.PI*2);
s.fill();

const starTex = new THREE.CanvasTexture(starC);

/* =====================
   STARS
===================== */
const COUNT = 1500;
const geo = new THREE.BufferGeometry();
const pos = new Float32Array(COUNT*3);
const base = new Float32Array(COUNT*3);

for(let i=0;i<COUNT;i++){
  const i3=i*3;
  pos[i3]=(Math.random()-0.5)*120;
  pos[i3+1]=(Math.random()-0.5)*120;
  pos[i3+2]=(Math.random()-0.5)*120;
  base.set(pos.slice(i3,i3+3),i3);
}
geo.setAttribute("position", new THREE.BufferAttribute(pos,3));

const mat = new THREE.PointsMaterial({
  map:starTex,
  transparent:true,
  size:0.9,
  depthWrite:false
});

const stars = new THREE.Points(geo,mat);
scene.add(stars);

/* =====================
   TEXT TARGET
===================== */
function textTargets(text){
  const c=document.createElement("canvas");
  c.width=900;c.height=250;
  const x=c.getContext("2d");
  x.fillStyle="white";
  x.font="72px serif";
  x.textAlign="center";
  x.fillText(text,c.width/2,c.height/2+25);
  const d=x.getImageData(0,0,c.width,c.height).data;
  const t=[];
  for(let y=0;y<c.height;y+=4){
    for(let x2=0;x2<c.width;x2+=4){
      if(d[(y*c.width+x2)*4+3]>150){
        t.push({x:(x2-c.width/2)*0.35,y:(c.height/2-y)*0.35,z:0});
      }
    }
  }
  return t;
}

const TARGET = textTargets("Dear Laily");
let show=false;

/* =====================
   MEDIAPIPE HANDS (FIX)
===================== */
const video=document.getElementById("video");
const status=document.getElementById("status");

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

let lastSeen=0;

hands.onResults(r=>{
  if(r.multiHandLandmarks){
    lastSeen=performance.now();
    status.textContent="detecting";

    const lm=r.multiHandLandmarks[0];
    const up=(t,p)=>lm[t].y<lm[p].y;
    let fingers=0;
    if(up(8,6))fingers++;
    if(up(12,10))fingers++;
    if(up(16,14))fingers++;
    if(up(20,18))fingers++;

    show = (fingers===1);
  }
});

/* CAMERA START (STABLE) */
const camUtil = new Camera(video,{
  onFrame: async ()=>{
    await hands.send({image:video});
  },
  width:640,
  height:640
});
camUtil.start();

/* =====================
   LOOP
===================== */
function animate(){
  requestAnimationFrame(animate);

  if(performance.now()-lastSeen>1200){
    status.textContent="idle";
    show=false;
  }

  const p=geo.attributes.position.array;
  for(let i=0;i<COUNT;i++){
    const i3=i*3;
    let tx,ty,tz;
    if(show && i<TARGET.length){
      ({x:tx,y:ty,z:tz}=TARGET[i]);
    }else{
      tx=base[i3];ty=base[i3+1];tz=base[i3+2];
    }
    p[i3]+= (tx-p[i3])*0.08;
    p[i3+1]+= (ty-p[i3+1])*0.08;
    p[i3+2]+= (tz-p[i3+2])*0.08;
  }
  geo.attributes.position.needsUpdate=true;
  renderer.render(scene,cam);
}
animate();
</script>
</body>
</html>
